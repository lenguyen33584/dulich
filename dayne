<?php
/**
 * Template for displaying single Tour post - Giao diá»‡n giá»‘ng BestPrice
 */
get_header();
global $post;

// Láº¥y cÃ¡c trÆ°á»ng tá»« ACF
$img           = get_field('anh_dai_dien_tour');
$gia           = get_field('gia_tour');
$thoi_gian     = get_field('thoi_gian');
$khoi_hanh     = get_field('khoihanh');
$diem_den      = get_field('diemden');
$phuong_tien   = get_field('phuong_tien');
$ma_tour       = get_field('ma_tour');
$lich_trinh    = get_field('lich_trinh');
$bao_gom       = get_field('bao_gom');
$khong_bao_gom = get_field('khong_bao_gom');
$chinh_sach    = get_field('chinh_sach');
$luu_y         = get_field('luu_y');

?>
<div class ="container">
<section class="tour-top-header">
	<h1 class="tour-title"><?php the_title(); ?></h1>
	<?php
	  $rating = get_field('danh_gia'); // VÃ­ dá»¥: 9.2
	  $review_count = get_field('so_luot_danh_gia'); // VÃ­ dá»¥: 3
	  if ($rating && $review_count):
		$label = 'Ráº¥t tá»‘t';
		if ($rating >= 9) $label = 'Tuyá»‡t vá»i';
		elseif ($rating >= 8) $label = 'Ráº¥t tá»‘t';
		elseif ($rating >= 7) $label = 'Tá»‘t';
		elseif ($rating >= 5) $label = 'Trung bÃ¬nh';
		else $label = 'KÃ©m';
	?>
	  <div class="tour-rating-box">
		<div class="score-box"><?php echo number_format($rating, 1); ?></div>
		<span class="score-label"><?php echo $label; ?></span>
		<span class="review-count">â€“ <?php echo $review_count; ?> Ä‘Ã¡nh giÃ¡</span>
	  </div>
	<?php endif; ?>
  <div class="tour-top-grid">
    <!-- áº¢nh Ä‘áº¡i diá»‡n -->
    <div class="tour-featured-img">
      <?php if (has_post_thumbnail()): ?>
        <?php the_post_thumbnail('large'); ?>
      <?php endif; ?>
    </div>

    <!-- ThÃ´ng tin tour -->
    <div class="tour-info-box">
      <p class="tour-duration"><span class="icon">â°</span> <?php the_field('thoi_gian'); ?></p>
      <p class="tour-location">
        <span class="icon">ğŸ“</span> <strong>Khá»Ÿi hÃ nh tá»«:</strong> <?php the_field('khoihanh'); ?>
      </p>
      <p class="tour-route">
        <span class="icon">ğŸ—ºï¸</span> <strong>Lá»™ trÃ¬nh:</strong> <?php the_field('lo_trinh'); ?>
      </p>
      <?php if ($gia_km = get_field('gia_tour')): ?>
        <p class="tour-price">
          GiÃ¡ tá»«: <del><?php echo number_format(get_field('gia_goc'), 0, ',', '.'); ?>Ä‘</del>
          <span><?php echo number_format($gia_km, 0, ',', '.'); ?>Ä‘</span>
        </p>
      <?php endif; ?>

      <!-- áº¢nh Ä‘áº£m báº£o 100% -->
      <div class="tour-guarantee">
        <img src="http://localhost/travelweb/wp-content/uploads/2025/04/icon-core-value-quality.png" alt="Äáº£m báº£o 100%">
      </div>

      <!-- Button vÃ  xem lá»‹ch -->
      <a href="#banggia" class="tour-schedule-btn">Xem lá»‹ch khá»Ÿi hÃ nh</a>
      <a href="#thanh-toan" class="tour-request-btn">Thanh toÃ¡n</a>
    </div>
  </div>
</section>
</div>
<div class ="container">
  <nav class="tour-tabs">
    <ul>
      <span class="tab" data-target="gioithieu">Giá»›i thiá»‡u</span>
      <span class="tab" data-target="lichtrinh">Lá»‹ch trÃ¬nh</span>
      <span class="tab" data-target="banggia">Báº£ng giÃ¡</span>
      <span class="tab" data-target="danhgia">ÄÃ¡nh giÃ¡</span>
      <span class="tab" data-target="hoidap">Há»i Ä‘Ã¡p</span>
    </ul>
  </nav>
</div>
<div class ="container">
  <section class="tour-description" id="gioithieu">
    <div class="entry-content">
      <?php the_content(); ?>
    </div>
    <?php if ($diem_noi_bat = get_field('diem_noi_bat')): ?>
	  <h2 id="gioithieu">ğŸ“Œ Äiá»ƒm ná»•i báº­t</h2>
	  <ul class="highlight-list">
		<?php
		  $lines = explode(PHP_EOL, trim($diem_noi_bat));
		  foreach ($lines as $line) {
			  echo '<li>âœ… ' . esc_html(trim($line)) . '</li>';
		  }
		?>
	  </ul>
	<?php endif; ?>
  </section>
</div>
<div class ="container">
  <section id="lichtrinh">
	  <h2>ğŸ“ Lá»‹ch trÃ¬nh tour</h2>
	  <div class="itinerary">
		<?php
		  $lich_trinh_text = get_field('lich_trinh');
		  $lich_trinh_arr = explode(PHP_EOL, trim($lich_trinh_text));

		  foreach ($lich_trinh_arr as $lt) {
			  if (strpos($lt, '###') !== false) {
				  list($tieu_de, $noi_dung) = explode('###', $lt, 2);
				  echo '<div class="day">' . esc_html(trim($tieu_de)) . '</div>';
				  echo '<div class="content">' . wp_kses_post(trim($noi_dung)) . '</div>';
			  }
		  }
		?>
	  </div>
	</section>
</div>
<div class ="container">
  <section id="banggia">
    <h2>ğŸ“Œ Báº£ng giÃ¡ (Khá»Ÿi hÃ nh tá»« <?php echo esc_html($khoi_hanh); ?>)</h2>
    <?php get_template_part('template-parts/price-table'); ?>
  </section>
</div>
<div class ="container">
 <section id="quytrinh">
  <h2>ğŸ“Œ Quy Ä‘á»‹nh dá»‹ch vá»¥</h2>

  <?php if ($bao_gom): ?>
    <div class="service-item"><span>âœ” GiÃ¡ bao gá»“m</span><span class="arrow">â–¼</span></div>
    <div class="service-content">
      <ul class="service-list">
        <?php
          $lines = explode(PHP_EOL, trim($bao_gom));
          foreach ($lines as $line) {
              echo '<li>' . esc_html(trim($line)) . '</li>';
          }
        ?>
      </ul>
    </div>
  <?php endif; ?>

  <?php if ($khong_bao_gom): ?>
    <div class="service-item"><span>ğŸš« GiÃ¡ khÃ´ng bao gá»“m</span><span class="arrow">â–¼</span></div>
    <div class="service-content">
      <ul class="service-list">
        <?php
          $lines = explode(PHP_EOL, trim($khong_bao_gom));
          foreach ($lines as $line) {
              echo '<li>' . esc_html(trim($line)) . '</li>';
          }
        ?>
      </ul>
    </div>
  <?php endif; ?>

  <?php if ($chinh_sach): ?>
    <div class="service-item"><span>âŒ Quy Ä‘á»‹nh huá»·/Ä‘á»•i Ä‘áº·t tour</span><span class="arrow">â–¼</span></div>
    <div class="service-content">
      <ul class="service-list">
        <?php
          $lines = explode(PHP_EOL, trim($chinh_sach));
          foreach ($lines as $line) {
              echo '<li>' . esc_html(trim($line)) . '</li>';
          }
        ?>
      </ul>
    </div>
  <?php endif; ?>

  <?php if ($luu_y): ?>
    <div class="service-item"><span style="color:red;">âš  LÆ°u Ã½ *</span><span class="arrow">â–¼</span></div>
    <div class="service-content">
      <ul class="service-list">
        <?php
          $lines = explode(PHP_EOL, trim($luu_y));
          foreach ($lines as $line) {
              echo '<li>' . esc_html(trim($line)) . '</li>';
          }
        ?>
      </ul>
    </div>
  <?php endif; ?>
</section>
</div>
<div class ="container">
<section id="danhgia">
  <h2>ğŸ“Œ ÄÃ¡nh giÃ¡</h2>

  <div class="review-summary">
    <div class="review-score">9.1</div>
    <div class="review-details">
      <p><strong>Tuyá»‡t vá»i</strong></p>
      <p>2 Ä‘Ã¡nh giÃ¡</p>
    </div>
  </div>

  <div class="review-item">
    <div class="review-score-small">9.2</div>
    <div class="review-text">
      <p class="author">Tuyá»‡t vá»i - Thu Huyá»n</p>
      <p>17/12/2024</p>
      <p>
        Gia Ä‘Ã¬nh mÃ¬nh vá»«a cÃ³ má»™t chuyáº¿n du lá»‹ch tuyá»‡t vá»i. MÃ¬nh chá»n tour nÃ y vÃ¬ lá»‹ch trÃ¬nh Ä‘i qua nhá»¯ng Ä‘á»‹a Ä‘iá»ƒm ráº¥t thÃº vá»‹ mÃ  cáº£ nhÃ  Ä‘á»u yÃªu thÃ­ch.
        <span class="extra hidden">Äáº·c biá»‡t, Ä‘á»“ Äƒn trong chuyáº¿n Ä‘i ráº¥t há»£p kháº©u vá»‹ cá»§a gia Ä‘Ã¬nh mÃ¬nh, ai cÅ©ng khen ngon. Khi Ä‘áº¿n Váº¡n LÃ½ TrÆ°á»ng ThÃ nh, bá»‘ máº¹ mÃ¬nh tháº­t sá»± vui má»«ng vÃ  hÃ o há»©ng. Náº¿u cÃ³ cÆ¡ há»™i cháº¯c cháº¯n mÃ¬nh sáº½ Ä‘i láº¡i tour nÃ y.</span>
        <span class="toggle-text">Xem thÃªm Â»</span>
      </p>
      <div class="review-images">
        <img src="https://via.placeholder.com/100x70" alt="áº¢nh Ä‘Ã¡nh giÃ¡">
        <img src="https://via.placeholder.com/100x70" alt="áº¢nh Ä‘Ã¡nh giÃ¡">
      </div>
    </div>
  </div>

  <!-- ThÃªm cÃ¡c Ä‘Ã¡nh giÃ¡ khÃ¡c tÆ°Æ¡ng tá»± -->
</section>
</div>

<?php
$current_id = get_the_ID();
$dia_diem = get_field('diadiem');

if ($dia_diem):
  $args = [
    'post_type' => 'tour',
    'posts_per_page' => 4,
    'post__not_in' => [$current_id],
    'meta_query' => [
      [
        'key' => 'diadiem',
        'value' => $dia_diem,
        'compare' => '='
      ]
    ]
  ];
  $related_tours = new WP_Query($args);
?>

<?php if ($related_tours->have_posts()): ?>
<div class ="container">
  <section id="tour-tuong-tu">
    <h2>ğŸ“Œ Tour tÆ°Æ¡ng tá»±</h2>
    <div class="related-tours">
      <?php while ($related_tours->have_posts()): $related_tours->the_post(); ?>
        <div class="related-tour-item">
          <a href="<?php the_permalink(); ?>">
            <?php if (has_post_thumbnail()): ?>
              <?php the_post_thumbnail('medium'); ?>
            <?php endif; ?>
            <h3><?php the_title(); ?></h3>
            <?php if ($gia = get_field('gia')): ?>
              <p class="related-price">GiÃ¡ tá»«: <?php echo number_format($gia, 0, ',', '.'); ?>Ä‘</p>
            <?php endif; ?>
          </a>
        </div>
      <?php endwhile; wp_reset_postdata(); ?>
    </div>
  </section>
</div>
<?php endif; ?>
<?php endif; ?>
<?php get_footer(); ?>
