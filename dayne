<?php
/**
 * Template for displaying single Tour post - Giao diá»‡n giá»‘ng BestPrice
 */
get_header();
global $post;

// Láº¥y cÃ¡c trÆ°á»ng tá»« ACF
$img           = get_field('anh_dai_dien_tour');
$gia           = get_field('gia_tour');
$thoi_gian     = get_field('thoi_gian');
$khoi_hanh     = get_field('khoihanh');
$diem_den      = get_field('diemden');
$phuong_tien   = get_field('phuong_tien');
$ma_tour       = get_field('ma_tour');
$lich_trinh    = get_field('lich_trinh');
$bao_gom       = get_field('bao_gom');
$khong_bao_gom = get_field('khong_bao_gom');
$chinh_sach    = get_field('chinh_sach');
$luu_y         = get_field('luu_y');
$combo_bao_gom = get_field('combo_bao_gom');
?>
<link rel="stylesheet" href="<?php echo get_stylesheet_directory_uri(); ?>/style-tour.css">
<div class = "custom-container" style="max-width:1140px;margin:auto;display:flex;">
<?php if (function_exists('custom_breadcrumb')) {
    custom_breadcrumb();
}?></div>
<div class ="container">
<section class="tour-top-header">
	<h1 class="tour-title"><?php the_title(); ?></h1>
	<?php
	  $rating = get_field('danh_gia'); // VÃ­ dá»¥: 9.2
	  $review_count = get_field('so_luot_danh_gia'); // VÃ­ dá»¥: 3
	  if ($rating && $review_count):
		$label = 'Ráº¥t tá»‘t';
		if ($rating >= 9) $label = 'Tuyá»‡t vá»i';
		elseif ($rating >= 8) $label = 'Ráº¥t tá»‘t';
		elseif ($rating >= 7) $label = 'Tá»‘t';
		elseif ($rating >= 5) $label = 'Trung bÃ¬nh';
		else $label = 'KÃ©m';
	?>
	  <div class="tour-rating-box">
		<div class="score-box"><?php echo number_format($rating, 1); ?></div>
		<span class="score-label"><?php echo $label; ?></span>
		<span class="review-count">â€“ <?php echo $review_count; ?> Ä‘Ã¡nh giÃ¡</span>
	  </div>
	<?php endif; ?>
  <div class="tour-top-grid">
    <!-- áº¢nh Ä‘áº¡i diá»‡n -->
    <div class="tour-featured-img">
      <?php if (has_post_thumbnail()): ?>
        <?php the_post_thumbnail('large'); ?>
      <?php endif; ?>
    </div>

    <!-- ThÃ´ng tin tour -->
    <div class="tour-info-box">
      <p class="tour-duration"><span class="icon">â°</span> <?php the_field('thoi_gian'); ?></p>
      <p class="tour-location">
        <span class="icon">ğŸ“</span> <strong>Khá»Ÿi hÃ nh tá»«:</strong> <?php the_field('khoihanh'); ?>
      </p>
      <p class="tour-route">
        <span class="icon">ğŸ—ºï¸</span> <strong>Lá»™ trÃ¬nh:</strong> <?php the_field('lo_trinh'); ?>
      </p>
      <?php if ($gia_km = get_field('gia_tour')): ?>
        <p class="tour-price">
          GiÃ¡ tá»«: <del><?php echo number_format(get_field('gia_goc'), 0, ',', '.'); ?>Ä‘</del>
          <span><?php echo number_format($gia_km, 0, ',', '.'); ?>Ä‘</span>
        </p>
      <?php endif; ?>

      <?php if ($combo_bao_gom): ?>
      <div class="combo-included-box">
        <strong>Combo bao gá»“m:</strong>
        <ul>
          <?php foreach (explode("\n", $combo_bao_gom) as $line): ?>
            <li><?= esc_html(trim($line)) ?></li>
          <?php endforeach; ?>
        </ul>
      </div>
      <?php endif; ?>

      <!-- áº¢nh Ä‘áº£m báº£o 100% -->
      <div class="tour-guarantee">
        <img src="http://localhost/travelweb/wp-content/uploads/2025/04/icon-core-value-quality.png" alt="Äáº£m báº£o 100%">
      </div>

      <!-- Button vÃ  xem lá»‹ch -->
      <a href="#banggia" class="tour-schedule-btn">Xem lá»‹ch khá»Ÿi hÃ nh</a>
		<?php if ($gia = get_field('gia_tour')): ?>
  <a href="<?= site_url('/thanh-toan?price=' . intval($gia)) ?>" class="tour-request-btn">Thanh toÃ¡n</a>
<?php endif; ?>
    </div>
  </div>
</section>
</div>
<!-- CÃ¡c pháº§n cÃ²n láº¡i giá»¯ nguyÃªn nhÆ° báº¡n Ä‘Ã£ cÃ³ -->
<div class ="container">
  <nav class="tour-tabs">
    <ul>
      <span class="tab" data-target="gioithieu">Giá»›i thiá»‡u</span>
      <span class="tab" data-target="lichtrinh">Lá»‹ch trÃ¬nh</span>
      <span class="tab" data-target="banggia">Báº£ng giÃ¡</span>
      <span class="tab" data-target="danhgia">ÄÃ¡nh giÃ¡</span>
      <span class="tab" data-target="hoidap">Há»i Ä‘Ã¡p</span>
    </ul>
  </nav>
</div>
<div class ="container">
  <section class="tour-description" id="gioithieu">
    <div class="entry-content">
      <?php the_content(); ?>
    </div>
    <?php if ($diem_noi_bat = get_field('diem_noi_bat')): ?>
	  <h2 id="gioithieu" style="font-size: 24px !important;">ğŸ“Œ Äiá»ƒm ná»•i báº­t</h2>
	  <ul class="highlight-list">
		<?php
		  $lines = explode(PHP_EOL, trim($diem_noi_bat));
		  foreach ($lines as $line) {
			  echo '<li>âœ… ' . esc_html(trim($line)) . '</li>';
		  }
		?>
	  </ul>
	<?php endif; ?>
  </section>
</div>
<div class ="container">
  <section id="lichtrinh">
    <h2 style="font-size: 24px !important;">ğŸ“ Lá»‹ch trÃ¬nh tour</h2>
    <div class="itinerary">
        <?php
        $lich_trinh_text = get_field('lich_trinh');
        $lich_trinh_arr = explode(PHP_EOL, trim($lich_trinh_text));

        $current_title = '';
        $current_content = '';

        foreach ($lich_trinh_arr as $lt) {
            if (strpos($lt, '|') !== false) {
            // In pháº§n trÆ°á»›c náº¿u cÃ³
            if (!empty($current_title)) {
                echo '<div class="day">' . esc_html(trim($current_title)) . '</div>';
                echo '<div class="content">' . nl2br(wp_kses_post(trim($current_content))) . '</div>';
            }

            // Báº¯t Ä‘áº§u pháº§n má»›i
            list($current_title, $first_line) = explode('|', $lt, 2);
            $current_content = trim($first_line);
            } else {
            // CÃ¡c dÃ²ng tiáº¿p theo lÃ  pháº§n ná»™i dung tiáº¿p tá»¥c
            $current_content .= "\n" . $lt;
            }
        }

        // In pháº§n cuá»‘i cÃ¹ng náº¿u cÃ²n
        if (!empty($current_title)) {
            echo '<div class="day">' . esc_html(trim($current_title)) . '</div>';
            echo '<div class="content">' . nl2br(wp_kses_post(trim($current_content))) . '</div>';
        }
        ?>
    </div>
    </section>
</div>

<div class = "container"> 
<?php if (have_rows('bang_gia')): ?>
<section id="bang-gia-tour">
  <h2>ğŸ“… Báº£ng giÃ¡ tour</h2>

  <?php
    // Láº¥y danh sÃ¡ch thÃ¡ng
    $months = [];
    $rows = get_field('bang_gia'); // láº¥y trÆ°á»›c rá»“i dÃ¹ng foreach
    foreach ($rows as $row) {
      $ngay = $row['ngay_khoi'];
      if ($ngay) {
        $month_key = date('Y-m', strtotime($ngay));
        $months[$month_key] = 'ThÃ¡ng ' . (int)date('m', strtotime($ngay));
      }
    }
  ?>

  <div class="month-tabs">
    <button class="tab-btn active" data-month="all">Táº¥t cáº£</button>
    <?php foreach ($months as $key => $label): ?>
      <button class="tab-btn" data-month="<?php echo esc_attr($key); ?>"><?php echo esc_html($label); ?></button>
    <?php endforeach; ?>
  </div>

  <div class="table-wrapper">
    <table class="price-table">
      <thead>
        <tr>
          <th>NgÃ y khá»Ÿi hÃ nh</th>
          <th>Háº¡ng tour</th>
          <th>GiÃ¡ tour</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <?php foreach ($rows as $row): 
          $ngay = $row['ngay_khoi'];
          $hang = $row['hang_tour'];
          $gia = $row['gia_tour'];
          $con_cho = $row['con_cho'];
          $thang = $ngay ? date('Y-m', strtotime($ngay)) : '';
        ?>
        <tr data-month="<?php echo esc_attr($thang); ?>">
          <td>
            <?php echo $ngay ? date('Y-m-d', strtotime($ngay)) : ''; ?><br>
            <span class="<?php echo ($con_cho === 'con') ? 'available' : 'unavailable'; ?>">
              <?php echo ($con_cho === 'CÃ²n chá»—') ? 'CÃ²n chá»—' : 'KÃ­n chá»—'; ?>
            </span>
          </td>
          <td><?php echo esc_html($hang); ?></td>
          <td>
            <strong><?php echo is_numeric($gia) ? number_format($gia, 0, ',', '.') . 'Ä‘' : 'LiÃªn há»‡'; ?></strong><br>
            <small>+ <?php echo is_numeric($gia) ? number_format($gia * 0.01, 0, ',', '.') . ' Ä‘iá»ƒm' : ''; ?></small>
          </td>
          <td>
            <?php if ($con_cho === 'CÃ²n chá»—'): ?>
              <a href="/thanh-toan?price=<?php echo esc_attr($gia); ?>" class="btn-mua-ngay">Giá»¯ chá»— ngay</a>
            <?php else: ?>
              <a href="#yeu-cau" class="btn-yeu-cau">Gá»­i yÃªu cáº§u</a>
            <?php endif; ?>
          </td>
        </tr>
        <?php endforeach; ?>
      </tbody>
    </table>
  </div>
</section>
<?php endif; ?>
</div>
<div class ="container">
 <section id="quytrinh">
  <h2>ğŸ“Œ Quy Ä‘á»‹nh dá»‹ch vá»¥</h2>

  <?php if ($bao_gom): ?>
    <div class="service-item"><span>âœ” GiÃ¡ bao gá»“m</span><span class="arrow">â–¼</span></div>
    <div class="service-content">
      <ul class="service-list">
        <?php
          $lines = explode(PHP_EOL, trim($bao_gom));
          foreach ($lines as $line) {
              echo '<li>' . esc_html(trim($line)) . '</li>';
          }
        ?>
      </ul>
    </div>
  <?php endif; ?>

  <?php if ($khong_bao_gom): ?>
    <div class="service-item"><span>ğŸš« GiÃ¡ khÃ´ng bao gá»“m</span><span class="arrow">â–¼</span></div>
    <div class="service-content">
      <ul class="service-list">
        <?php
          $lines = explode(PHP_EOL, trim($khong_bao_gom));
          foreach ($lines as $line) {
              echo '<li>' . esc_html(trim($line)) . '</li>';
          }
        ?>
      </ul>
    </div>
  <?php endif; ?>

  <?php if ($chinh_sach): ?>
    <div class="service-item"><span>âŒ Quy Ä‘á»‹nh huá»·/Ä‘á»•i Ä‘áº·t tour</span><span class="arrow">â–¼</span></div>
    <div class="service-content">
      <ul class="service-list">
        <?php
          $lines = explode(PHP_EOL, trim($chinh_sach));
          foreach ($lines as $line) {
              echo '<li>' . esc_html(trim($line)) . '</li>';
          }
        ?>
      </ul>
    </div>
  <?php endif; ?>

  <?php if ($luu_y): ?>
    <div class="service-item"><span style="color:red;">âš  LÆ°u Ã½ *</span><span class="arrow">â–¼</span></div>
    <div class="service-content">
        <?php
        $lines = explode(PHP_EOL, trim($luu_y));
        if (!empty($lines)) {
            echo '<strong>' . esc_html(trim(array_shift($lines))) . '</strong>'; // DÃ²ng Ä‘áº§u in Ä‘áº­m, khÃ´ng <li>
        }
        ?>
        <ul class="service-list">
        <?php
            foreach ($lines as $line) {
                echo '<li>' . esc_html(trim($line)) . '</li>';
            }
        ?>
        </ul>
    </div>
    <?php endif; ?>
</section>
</div>
<div class ="container">
<?php if (get_field('luu_y_them')): ?>
  <section id="luu-y-them" class="note-extra-wrapper">
    <h2>ğŸ“ LÆ°u Ã½ thÃªm</h2>
    <div class="note-extra-content">
      <?php the_field('luu_y_them'); ?>
    </div>
  </section>
<?php endif; ?>
</div>
<div class ="container">
<section id="danhgia">
  <h2>ğŸ“Œ ÄÃ¡nh giÃ¡</h2>

  <div class="review-summary">
    <div class="review-score">9.1</div>
    <div class="review-details">
      <p><strong>Tuyá»‡t vá»i</strong></p>
      <p>2 Ä‘Ã¡nh giÃ¡</p>
    </div>
  </div>

  <div class="review-item">
    <div class="review-score-small">9.2</div>
    <div class="review-text">
      <p class="author">Tuyá»‡t vá»i - Thu Huyá»n</p>
      <p>17/12/2024</p>
      <p>
        Gia Ä‘Ã¬nh mÃ¬nh vá»«a cÃ³ má»™t chuyáº¿n du lá»‹ch tuyá»‡t vá»i. MÃ¬nh chá»n tour nÃ y vÃ¬ lá»‹ch trÃ¬nh Ä‘i qua nhá»¯ng Ä‘á»‹a Ä‘iá»ƒm ráº¥t thÃº vá»‹ mÃ  cáº£ nhÃ  Ä‘á»u yÃªu thÃ­ch.
        <span class="extra hidden">Äáº·c biá»‡t, Ä‘á»“ Äƒn trong chuyáº¿n Ä‘i ráº¥t há»£p kháº©u vá»‹ cá»§a gia Ä‘Ã¬nh mÃ¬nh, ai cÅ©ng khen ngon. Khi Ä‘áº¿n Váº¡n LÃ½ TrÆ°á»ng ThÃ nh, bá»‘ máº¹ mÃ¬nh tháº­t sá»± vui má»«ng vÃ  hÃ o há»©ng. Náº¿u cÃ³ cÆ¡ há»™i cháº¯c cháº¯n mÃ¬nh sáº½ Ä‘i láº¡i tour nÃ y.</span>
        <span class="toggle-text">Xem thÃªm Â»</span>
      </p>
      <div class="review-images">
        <img src="https://via.placeholder.com/100x70" alt="áº¢nh Ä‘Ã¡nh giÃ¡">
        <img src="https://via.placeholder.com/100x70" alt="áº¢nh Ä‘Ã¡nh giÃ¡">
      </div>
    </div>
  </div>
  <div class="review-item">
    <div class="review-score-small">9.2</div>
    <div class="review-text">
      <p class="author">Tuyá»‡t vá»i - Thu Huyá»n</p>
      <p>17/12/2024</p>
      <p>
        Gia Ä‘Ã¬nh mÃ¬nh vá»«a cÃ³ má»™t chuyáº¿n du lá»‹ch tuyá»‡t vá»i. MÃ¬nh chá»n tour nÃ y vÃ¬ lá»‹ch trÃ¬nh Ä‘i qua nhá»¯ng Ä‘á»‹a Ä‘iá»ƒm ráº¥t thÃº vá»‹ mÃ  cáº£ nhÃ  Ä‘á»u yÃªu thÃ­ch.
        <span class="extra hidden">Äáº·c biá»‡t, Ä‘á»“ Äƒn trong chuyáº¿n Ä‘i ráº¥t há»£p kháº©u vá»‹ cá»§a gia Ä‘Ã¬nh mÃ¬nh, ai cÅ©ng khen ngon. Khi Ä‘áº¿n Váº¡n LÃ½ TrÆ°á»ng ThÃ nh, bá»‘ máº¹ mÃ¬nh tháº­t sá»± vui má»«ng vÃ  hÃ o há»©ng. Náº¿u cÃ³ cÆ¡ há»™i cháº¯c cháº¯n mÃ¬nh sáº½ Ä‘i láº¡i tour nÃ y.</span>
        <span class="toggle-text">Xem thÃªm Â»</span>
      </p>
      <div class="review-images">
        <img src="https://via.placeholder.com/100x70" alt="áº¢nh Ä‘Ã¡nh giÃ¡">
        <img src="https://via.placeholder.com/100x70" alt="áº¢nh Ä‘Ã¡nh giÃ¡">
      </div>
    </div>
  </div>
  <div class="review-item">
    <div class="review-score-small">9.2</div>
    <div class="review-text">
      <p class="author">Tuyá»‡t vá»i - Thu Huyá»n</p>
      <p>17/12/2024</p>
      <p>
        Gia Ä‘Ã¬nh mÃ¬nh vá»«a cÃ³ má»™t chuyáº¿n du lá»‹ch tuyá»‡t vá»i. MÃ¬nh chá»n tour nÃ y vÃ¬ lá»‹ch trÃ¬nh Ä‘i qua nhá»¯ng Ä‘á»‹a Ä‘iá»ƒm ráº¥t thÃº vá»‹ mÃ  cáº£ nhÃ  Ä‘á»u yÃªu thÃ­ch.
        <span class="extra hidden">Äáº·c biá»‡t, Ä‘á»“ Äƒn trong chuyáº¿n Ä‘i ráº¥t há»£p kháº©u vá»‹ cá»§a gia Ä‘Ã¬nh mÃ¬nh, ai cÅ©ng khen ngon. Khi Ä‘áº¿n Váº¡n LÃ½ TrÆ°á»ng ThÃ nh, bá»‘ máº¹ mÃ¬nh tháº­t sá»± vui má»«ng vÃ  hÃ o há»©ng. Náº¿u cÃ³ cÆ¡ há»™i cháº¯c cháº¯n mÃ¬nh sáº½ Ä‘i láº¡i tour nÃ y.</span>
        <span class="toggle-text">Xem thÃªm Â»</span>
      </p>
      <div class="review-images">
        <img src="https://via.placeholder.com/100x70" alt="áº¢nh Ä‘Ã¡nh giÃ¡">
        <img src="https://via.placeholder.com/100x70" alt="áº¢nh Ä‘Ã¡nh giÃ¡">
      </div>
    </div>
  </div>
  <!-- ThÃªm cÃ¡c Ä‘Ã¡nh giÃ¡ khÃ¡c tÆ°Æ¡ng tá»± -->
</section>
</div>

<?php
$current_id = get_the_ID();
$dia_diem = get_field('diadiem');

if ($dia_diem):
  $args = [
    'post_type' => 'tour',
    'posts_per_page' => 4,
    'post__not_in' => [$current_id],
    'meta_query' => [
      [
        'key' => 'diadiem',
        'value' => $dia_diem,
        'compare' => '='
      ]
    ]
  ];
  $related_tours = new WP_Query($args);
?>

<?php if ($related_tours->have_posts()): ?>
<div class ="container">
  <section id="tour-tuong-tu">
    <h2>ğŸ“Œ Tour tÆ°Æ¡ng tá»±</h2>
    <div class="related-tours">
      <?php while ($related_tours->have_posts()): $related_tours->the_post(); ?>
        <div class="related-tour-item">
          <a href="<?php the_permalink(); ?>">
            <?php if (has_post_thumbnail()): ?>
              <?php the_post_thumbnail('medium'); ?>
            <?php endif; ?>
            <h3><?php the_title(); ?></h3>
            <?php if ($gia = get_field('gia')): ?>
              <p class="related-price">GiÃ¡ tá»«: <?php echo number_format($gia, 0, ',', '.'); ?>Ä‘</p>
            <?php endif; ?>
          </a>
        </div>
      <?php endwhile; wp_reset_postdata(); ?>
    </div>
  </section>
</div>
<?php endif; ?>
<?php endif; ?>
<?php get_footer(); ?>
