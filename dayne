from flask import Flask, request, send_file, after_this_request
from flask_cors import CORS
import subprocess
import os

app = Flask(__name__)
CORS(app)

@app.route("/run-bot", methods=["POST"])
def run_bot():
    price = request.form.get("price", "no-price")
    print(f"ğŸ’° Nháº­n yÃªu cáº§u cháº¡y bot vá»›i giÃ¡: {price}")

    # Gá»i bot xá»­ lÃ½
    result = subprocess.run(["python3", "bot.py", price], capture_output=True, text=True)
    print(result.stdout)
    print(result.stderr)

    # ÄÆ°á»ng dáº«n áº£nh QR Ä‘Ã£ cáº¯t vÃ  áº£nh toÃ n trang
    qr_image_path = os.path.join("static", "qr_code_detected.png")
    full_image_path = os.path.join("static", "full_page.png")

    if os.path.exists(qr_image_path):
        # âœ… Sau khi gá»­i file QR Ä‘Ã£ cáº¯t, xÃ³a cáº£ 2 áº£nh
        @after_this_request
        def remove_files(response):
            for path in [qr_image_path, full_image_path]:
                try:
                    if os.path.exists(path):
                        os.remove(path)
                        print(f"ğŸ—‘ï¸ ÄÃ£ xÃ³a áº£nh: {path}")
                except Exception as e:
                    print(f"âŒ Lá»—i khi xÃ³a áº£nh {path}:", e)
            return response

        return send_file(qr_image_path, mimetype="image/png")
    else:
        return "KhÃ´ng tÃ¬m tháº¥y áº£nh QR Ä‘Ã£ cáº¯t!", 500

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8080)
