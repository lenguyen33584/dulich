<?php
/**
 * Theme functions and definitions
 *
 * @package HelloElementor
 */

if ( ! defined( 'ABSPATH' ) ) {
	exit; // Exit if accessed directly.
}

define( 'HELLO_ELEMENTOR_VERSION', '3.4.1' );
define( 'EHP_THEME_SLUG', 'hello-elementor' );

define( 'HELLO_THEME_PATH', get_template_directory() );
define( 'HELLO_THEME_URL', get_template_directory_uri() );
define( 'HELLO_THEME_ASSETS_PATH', HELLO_THEME_PATH . '/assets/' );
define( 'HELLO_THEME_ASSETS_URL', HELLO_THEME_URL . '/assets/' );
define( 'HELLO_THEME_SCRIPTS_PATH', HELLO_THEME_ASSETS_PATH . 'js/' );
define( 'HELLO_THEME_SCRIPTS_URL', HELLO_THEME_ASSETS_URL . 'js/' );
define( 'HELLO_THEME_STYLE_PATH', HELLO_THEME_ASSETS_PATH . 'css/' );
define( 'HELLO_THEME_STYLE_URL', HELLO_THEME_ASSETS_URL . 'css/' );
define( 'HELLO_THEME_IMAGES_PATH', HELLO_THEME_ASSETS_PATH . 'images/' );
define( 'HELLO_THEME_IMAGES_URL', HELLO_THEME_ASSETS_URL . 'images/' );

if ( ! isset( $content_width ) ) {
	$content_width = 800; // Pixels.
}

if ( ! function_exists( 'hello_elementor_setup' ) ) {
	/**
	 * Set up theme support.
	 *
	 * @return void
	 */
	function hello_elementor_setup() {
		if ( is_admin() ) {
			hello_maybe_update_theme_version_in_db();
		}

		if ( apply_filters( 'hello_elementor_register_menus', true ) ) {
			register_nav_menus( [ 'menu-1' => esc_html__( 'Header', 'hello-elementor' ) ] );
			register_nav_menus( [ 'menu-2' => esc_html__( 'Footer', 'hello-elementor' ) ] );
		}

		if ( apply_filters( 'hello_elementor_post_type_support', true ) ) {
			add_post_type_support( 'page', 'excerpt' );
		}

		if ( apply_filters( 'hello_elementor_add_theme_support', true ) ) {
			add_theme_support( 'post-thumbnails' );
			add_theme_support( 'automatic-feed-links' );
			add_theme_support( 'title-tag' );
			add_theme_support(
				'html5',
				[
					'search-form',
					'comment-form',
					'comment-list',
					'gallery',
					'caption',
					'script',
					'style',
				]
			);
			add_theme_support(
				'custom-logo',
				[
					'height'      => 100,
					'width'       => 350,
					'flex-height' => true,
					'flex-width'  => true,
				]
			);
			add_theme_support( 'align-wide' );
			add_theme_support( 'responsive-embeds' );

			/*
			 * Editor Styles
			 */
			add_theme_support( 'editor-styles' );
			add_editor_style( 'editor-styles.css' );

			/*
			 * WooCommerce.
			 */
			if ( apply_filters( 'hello_elementor_add_woocommerce_support', true ) ) {
				// WooCommerce in general.
				add_theme_support( 'woocommerce' );
				// Enabling WooCommerce product gallery features (are off by default since WC 3.0.0).
				// zoom.
				add_theme_support( 'wc-product-gallery-zoom' );
				// lightbox.
				add_theme_support( 'wc-product-gallery-lightbox' );
				// swipe.
				add_theme_support( 'wc-product-gallery-slider' );
			}
		}
	}
}
add_action( 'after_setup_theme', 'hello_elementor_setup' );

function hello_maybe_update_theme_version_in_db() {
	$theme_version_option_name = 'hello_theme_version';
	// The theme version saved in the database.
	$hello_theme_db_version = get_option( $theme_version_option_name );

	// If the 'hello_theme_version' option does not exist in the DB, or the version needs to be updated, do the update.
	if ( ! $hello_theme_db_version || version_compare( $hello_theme_db_version, HELLO_ELEMENTOR_VERSION, '<' ) ) {
		update_option( $theme_version_option_name, HELLO_ELEMENTOR_VERSION );
	}
}

if ( ! function_exists( 'hello_elementor_display_header_footer' ) ) {
	/**
	 * Check whether to display header footer.
	 *
	 * @return bool
	 */
	function hello_elementor_display_header_footer() {
		$hello_elementor_header_footer = true;

		return apply_filters( 'hello_elementor_header_footer', $hello_elementor_header_footer );
	}
}

if ( ! function_exists( 'hello_elementor_scripts_styles' ) ) {
	/**
	 * Theme Scripts & Styles.
	 *
	 * @return void
	 */
	function hello_elementor_scripts_styles() {
		$min_suffix = defined( 'SCRIPT_DEBUG' ) && SCRIPT_DEBUG ? '' : '.min';

		if ( apply_filters( 'hello_elementor_enqueue_style', true ) ) {
			wp_enqueue_style(
				'hello-elementor',
				get_template_directory_uri() . '/style' . $min_suffix . '.css',
				[],
				HELLO_ELEMENTOR_VERSION
			);
		}

		if ( apply_filters( 'hello_elementor_enqueue_theme_style', true ) ) {
			wp_enqueue_style(
				'hello-elementor-theme-style',
				get_template_directory_uri() . '/theme' . $min_suffix . '.css',
				[],
				HELLO_ELEMENTOR_VERSION
			);
		}

		if ( hello_elementor_display_header_footer() ) {
			wp_enqueue_style(
				'hello-elementor-header-footer',
				get_template_directory_uri() . '/header-footer' . $min_suffix . '.css',
				[],
				HELLO_ELEMENTOR_VERSION
			);
		}
	}
}
add_action( 'wp_enqueue_scripts', 'hello_elementor_scripts_styles' );

if ( ! function_exists( 'hello_elementor_register_elementor_locations' ) ) {
	/**
	 * Register Elementor Locations.
	 *
	 * @param ElementorPro\Modules\ThemeBuilder\Classes\Locations_Manager $elementor_theme_manager theme manager.
	 *
	 * @return void
	 */
	function hello_elementor_register_elementor_locations( $elementor_theme_manager ) {
		if ( apply_filters( 'hello_elementor_register_elementor_locations', true ) ) {
			$elementor_theme_manager->register_all_core_location();
		}
	}
}
add_action( 'elementor/theme/register_locations', 'hello_elementor_register_elementor_locations' );

if ( ! function_exists( 'hello_elementor_content_width' ) ) {
	/**
	 * Set default content width.
	 *
	 * @return void
	 */
	function hello_elementor_content_width() {
		$GLOBALS['content_width'] = apply_filters( 'hello_elementor_content_width', 800 );
	}
}
add_action( 'after_setup_theme', 'hello_elementor_content_width', 0 );

if ( ! function_exists( 'hello_elementor_add_description_meta_tag' ) ) {
	/**
	 * Add description meta tag with excerpt text.
	 *
	 * @return void
	 */
	function hello_elementor_add_description_meta_tag() {
		if ( ! apply_filters( 'hello_elementor_description_meta_tag', true ) ) {
			return;
		}

		if ( ! is_singular() ) {
			return;
		}

		$post = get_queried_object();
		if ( empty( $post->post_excerpt ) ) {
			return;
		}

		echo '<meta name="description" content="' . esc_attr( wp_strip_all_tags( $post->post_excerpt ) ) . '">' . "\n";
	}
}
add_action( 'wp_head', 'hello_elementor_add_description_meta_tag' );

// Settings page
require get_template_directory() . '/includes/settings-functions.php';

// Header & footer styling option, inside Elementor
require get_template_directory() . '/includes/elementor-functions.php';

if ( ! function_exists( 'hello_elementor_customizer' ) ) {
	// Customizer controls
	function hello_elementor_customizer() {
		if ( ! is_customize_preview() ) {
			return;
		}

		if ( ! hello_elementor_display_header_footer() ) {
			return;
		}

		require get_template_directory() . '/includes/customizer-functions.php';
	}
}
add_action( 'init', 'hello_elementor_customizer' );

if ( ! function_exists( 'hello_elementor_check_hide_title' ) ) {
	/**
	 * Check whether to display the page title.
	 *
	 * @param bool $val default value.
	 *
	 * @return bool
	 */
	function hello_elementor_check_hide_title( $val ) {
		if ( defined( 'ELEMENTOR_VERSION' ) ) {
			$current_doc = Elementor\Plugin::instance()->documents->get( get_the_ID() );
			if ( $current_doc && 'yes' === $current_doc->get_settings( 'hide_title' ) ) {
				$val = false;
			}
		}
		return $val;
	}
}
add_filter( 'hello_elementor_page_title', 'hello_elementor_check_hide_title' );
//code tự thêm từ đây
//code form search
function tour_search_form_shortcode() {
    ob_start(); ?>
    
    <style>
    .tour-search-wrapper {
        max-width: 1140px;
        margin-top: -60px;
        position: relative;
        z-index: 99;        
    }
    .tour-search-form {
        background: #fff;
        padding: 24px 32px;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        display: flex;
        gap: 16px;
        align-items: flex-end;
        flex-wrap: wrap;
    }
    .tour-search-form label {
        font-weight: 500;
        font-size: 14px;
        color: #ccc;
        display: block;
        margin-bottom: 6px;
    }
    .tour-search-form select {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #828282;
    }
    .tour-search-form select option {
        color : #555
    }
    .tour-search-form select {
        color : #555
    }
    .tour-search-form button {
        padding: 12px 24px;
        background-color: #660000;
        color: #fff;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
    }
    @media (max-width: 768px) {
        .tour-search-form {
            flex-direction: column;
            align-items: stretch;
        }
        .form-group {
            flex: 1 1 100%;
        }
        .form-group button {
            width: 100%;
        }
    }
    </style>

    <div class="tour-search-wrapper">
    <form onsubmit="return redirectToVungMien(event);" class="tour-search-form">

        <!-- Địa điểm -->
        <div style="flex: 1;">
            <label>ĐỊA ĐIỂM</label>
            <select name="diadiem">
			  <option value="">Bạn muốn đi đâu?</option>
			  <?php
			  $terms = get_terms([
				  'taxonomy' => 'vung_mien_tour',
				  'hide_empty' => false,
				]);

			  foreach ($terms as $term) {
				  // Tạo slug phân cấp đầy đủ
				  $slug_parts = [];
				  $current = $term;
				  while ($current && $current->parent != 0) {
					  array_unshift($slug_parts, $current->slug);
					  $current = get_term($current->parent, 'vung_mien_tour');
				  }
				  if ($current) {
					  array_unshift($slug_parts, $current->slug);
				  }
				  $full_slug = $term->slug;

				  echo '<option value="' . esc_attr($term->slug) . '" data-full-slug="' . esc_attr($full_slug) . '">' . esc_html($term->name) . '</option>';
			  }
			  ?>
			</select>
        </div>

        <!-- Khởi hành -->
        <div style="flex: 1;">
            <label>KHỞI HÀNH TỪ</label>
            <select name="khoihanh">
                <option value="">Vui lòng chọn</option>
                <option value="ha-noi">Hà Nội</option>
                <option value="ho-chi-minh">Hồ Chí Minh</option>
                <option value="da-nang">Đà Nẵng</option>
                <option value="hai-phong">Hải Phòng</option>
            </select>
        </div>

        <!-- Nút -->
        <div style="flex: 0 0 auto;">
            <button type="submit">Tìm ngay</button>
        </div>
    </form>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
		const form = document.querySelector('.tour-search-form');
		form.addEventListener('submit', function (e) {
			e.preventDefault();
			const select = form.querySelector('[name="diadiem"]');
			const slug = select.options[select.selectedIndex].getAttribute('data-full-slug');

			if (slug) {
				window.location.href = '/vung_mien_tour/' + slug + '/';
			}
		});
	});
    </script>

    <?php
    return ob_get_clean();
}
add_shortcode('tour_search_form', 'tour_search_form_shortcode');

/// shortcode results


// chỉnh css cho tour 
function enqueue_tour_styles() {
    if (is_singular('tour','combo')) {
        wp_enqueue_style('tour-style', get_template_directory_uri() . '/style-tour.css');
    }
}
add_action('wp_enqueue_scripts', 'enqueue_tour_styles');

// gọi script của tour-post
function enqueue_tour_scripts() {
    if (is_singular('tour','combo')) {
        wp_enqueue_script('tour-js', get_template_directory_uri() . '/assets/js/tour-interaction.js', [], null, true);
    }
}
add_action('wp_enqueue_scripts', 'enqueue_tour_scripts');



// short code taxonomy dulich nước ngoài
function render_vung_mien_leaf_terms($atts) {
    ob_start();

    $atts = shortcode_atts([
        'parent_slug' => '',
        'style' => 'circle', // circle | rectangle | image-overlay
        'limit' => 8
    ], $atts);

    $parent_term = get_term_by('slug', $atts['parent_slug'], 'vung_mien_tour');
    if (!$parent_term) return 'Không tìm thấy vùng miền cha.';

    $mid_terms = get_terms([
        'taxonomy' => 'vung_mien_tour',
        'parent' => $parent_term->term_id,
        'hide_empty' => false,
    ]);

    $final_terms = [];
    foreach ($mid_terms as $mid) {
        $sub_terms = get_terms([
            'taxonomy' => 'vung_mien_tour',
            'parent' => $mid->term_id,
            'hide_empty' => false,
        ]);
        $final_terms = array_merge($final_terms, $sub_terms);
    }

    if (empty($final_terms)) return 'Không có dữ liệu.';

    // Sắp xếp theo số lượng bài viết (count) giảm dần
    usort($final_terms, function($a, $b) {
        return $b->count - $a->count;
    });

    // Lấy đúng số lượng limit (ví dụ 8)
    $final_terms = array_slice($final_terms, 0, $atts['limit']);

    // Style hiển thị
    $style = $atts['style'];

    // Bắt đầu HTML
    echo '<div class="vungmien-list" style="display: flex; flex-wrap: nowrap; gap: 16px; justify-content: center; overflow-x: auto;">';

    foreach ($final_terms as $term) {
        $thumbnail = get_field('thumbnail', $term);
        $count = $term->count;
        $link = get_term_link($term);

        if ($style === 'circle') {
            echo '
            <a href="' . esc_url($link) . '" style="text-align:center; width:100px; flex: 0 0 auto; text-decoration: none; color:inherit;">
              <div style="width: 110px; height: 110px; border-radius: 20%; overflow: hidden; margin: auto;">
                <img src="' . esc_url($thumbnail) . '" style="width:100%; height:100%; object-fit:cover;">
              </div>
              <strong style="font-size: 14px; display: block; margin-top: 5px;">' . esc_html($term->name) . '</strong>
              <span style="font-size: 12px; color:#888;">' . $count . ' tour</span>
            </a>';
        }

        // Các style khác nếu dùng tiếp
        elseif ($style === 'rectangle' || $style === 'image-overlay') {
            // Không chỉnh lại ở đây vì bạn không dùng cho nước ngoài
        }
    }

    echo '</div>';

    // Nút "Xem tất cả"
    echo '
    <div style="text-align:center; margin-top: 16px;">
        <a href="https://annamtourist.rf.gd/vung_mien_tour/du-lich-nuoc-ngoai/" 
           style="display:inline-block; padding: 1px 10px; border: 2px solid #660000; color: #660000; text-decoration: none; border-radius: 4px; background-color: #fff; font-weight: bold; transition: all 0.3s;">
           Xem tất cả &gt;
        </a>
        <style>
            .vungmien-list + div a:hover {
                background-color: #660000;
                color: #fff;
            }
        </style>
    </div>';
    return ob_get_clean();
}
add_shortcode('vungmien_leaf', 'render_vung_mien_leaf_terms');

// short code du lịch nước ngoài
function render_vung_mien_lead_terms($atts) {
    ob_start();

    $atts = shortcode_atts([
        'parent_slug' => '',
        'style' => 'circle', // circle | rectangle | image-overlay
        'limit' => 4
    ], $atts);

    $parent_term = get_term_by('slug', $atts['parent_slug'], 'vung_mien_tour');
    if (!$parent_term) return 'Không tìm thấy vùng miền cha.';

    $mid_terms = get_terms([
        'taxonomy' => 'vung_mien_tour',
        'parent' => $parent_term->term_id,
        'hide_empty' => false,
    ]);

    $final_terms = [];

    foreach ($mid_terms as $mid) {
        $sub_terms = get_terms([
            'taxonomy' => 'vung_mien_tour',
            'parent' => $mid->term_id,
            'hide_empty' => false,
        ]);
        $final_terms = array_merge($final_terms, $sub_terms);
    }

    if (empty($final_terms)) return 'Không có dữ liệu.';
    $final_terms = array_slice($final_terms, 0, $atts['limit']);

    echo '<div class="vungmien-scroll-wrapper" style="overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 10px;">
        <div class="vungmien-list" style="display: flex; flex-wrap: nowrap; gap: 16px; min-width: max-content;">';

    foreach ($final_terms as $term) {
        $thumbnail = get_field('thumbnail', $term);
        $count = $term->count;
        $link = get_term_link($term);

        if ($atts['style'] === 'image-overlay') {
            echo '
            <a href="' . esc_url($link) . '" style="position: relative; width: calc(25% - 12px); border-radius: 8px; overflow: hidden; text-decoration: none;">
                <img src="' . esc_url($thumbnail) . '" style="width: 100%; height: 180px; object-fit: cover;">
                <div style="position: absolute; bottom: 10px; left: 12px; color: white; font-weight: bold; font-size: 16px; text-shadow: 0 1px 3px rgba(0,0,0,0.7);">
                    ' . esc_html($term->name) . '<br>
                    <span style="font-weight: normal; font-size: 13px;">' . $count . ' tour</span>
                </div>
            </a>';
        }

        elseif ($atts['style'] === 'rectangle') {
            echo '
            <a href="' . esc_url($link) . '" style="flex: 1 1 220px; max-width: 250px; text-decoration:none; color:inherit;">
              <div style="width:100%; height:140px; border-radius: 10px; overflow: hidden; margin-bottom: 6px;">
                <img src="' . esc_url($thumbnail) . '" style="width:100%; height:100%; object-fit:cover;">
              </div>
              <div style="font-weight: bold;">' . esc_html($term->name) . '</div>
              <div style="font-size: 13px; color: #888;">' . $count . ' tour</div>
            </a>';
        }

        else {
            echo '
            <a href="' . esc_url($link) . '" style="text-align:center; width:120px; text-decoration: none; color:inherit;">
              <div style="width: 100px; height: 100px; border-radius: 50%; overflow: hidden; margin: auto;">
                <img src="' . esc_url($thumbnail) . '" style="width:100%; height:100%; object-fit:cover;">
              </div>
<strong>' . esc_html($term->name) . '</strong><br>
              <span style="font-size: 12px;">' . $count . ' tour</span>
            </a>';
        }
    }

    echo '</div></div>';
    // Nút "Xem tất cả"
    echo '
    <div style="text-align:center; margin-top: 16px;">
        <a href="https://annamtourist.rf.gd/vung_mien_tour/du-lich-trong-nuoc/" 
           style="display:inline-block; padding: 1px 10px; border: 2px solid #660000; color: #660000; text-decoration: none; border-radius: 4px; background-color: #fff; font-weight: bold; transition: all 0.3s;">
           Xem tất cả &gt;
        </a>
        <style>
            .vungmien-list + div a:hover {
                background-color: #660000;
                color: #fff;
            }
        </style>
    </div>';
    return ob_get_clean();
}
add_shortcode('vungmien_lead', 'render_vung_mien_lead_terms');


// hotel filter
// hotel filter
function hotel_filter_form_shortcode() {
    ob_start();
    ?>

    <style>
    .hotel-search-wrapper {
        max-width: 1140px;
        margin-top: -100px;
        position: relative;
        z-index: 99;
    }
    .hotel-search-form {
        background: #fff;
        padding: 24px 32px;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    .hotel-search-row {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
    }
    .hotel-search-form label {
        font-weight: 500;
        font-size: 14px;
        color: #555;
        margin-bottom: 4px;
        display: block;
    }
    .hotel-search-form select,
    .hotel-search-form input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
    }
    .guest-summary {
        padding: 10px;
        border: 1px solid #828282;
        border-radius: 8px;
        cursor: pointer;
    }
    .guest-box {
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        padding: 15px;
        border-radius: 10px;
        display: none;
        top: 100%;
        width: 260px;
        margin-top: 5px;
        z-index: 100;
    }
    .guest-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .guest-counter button {
        background: #ccc;
        border: none;
        padding: 4px 10px;
        border-radius: 50%;
        font-weight: bold;
        cursor: pointer;
    }
    .guest-counter span {
        margin: 0 10px;
        font-weight: bold;
    }
    .search-button button {
        padding: 12px 24px;
        background-color: #660000;
        color: #fff;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
    }
    </style>

    <div class="hotel-search-wrapper">
    <form action="" method="get" class="hotel-search-form" onsubmit="return redirectToLocation(event);">

        <!-- Địa điểm -->
        <div>
            <label>ĐỊA ĐIỂM</label>
            <select name="location" id="location-select">
                <option value="">Thành phố, Địa danh, Khách sạn...</option>
                <?php
                $terms = get_terms([
                    'taxonomy' => 'vung_mien_hotel',
                    'hide_empty' => false,
                ]);
                foreach ($terms as $term) {
                    $parent = get_term($term->parent, 'vung_mien_hotel');
                    $grandparent = $parent ? get_term($parent->parent, 'vung_mien_hotel') : null;
                    if ($grandparent) {
                        echo '<option value="' . esc_attr($term->slug) . '">' . esc_html($term->name) . '</option>';
                    }
                }
                ?>
            </select>
        </div>

        <!-- Hàng dưới: ngày + khách + nút -->
        <div class="hotel-search-row">
            <!-- Nhận phòng -->
            <div style="flex: 1; min-width: 200px;">
                <label>NHẬN PHÒNG</label>
                <input type="date" name="checkin">
            </div>

            <!-- Trả phòng -->
            <div style="flex: 1; min-width: 200px;">
                <label>TRẢ PHÒNG</label>
                <input type="date" name="checkout">
            </div>

            <!-- Hành khách -->
            <div style="flex: 1; min-width: 200px; position: relative;">
                <label>HÀNH KHÁCH</label>
                <div class="guest-summary" onclick="document.getElementById('guest-box').style.display = (document.getElementById('guest-box').style.display === 'block' ? 'none' : 'block')">
                    <span id="guest-summary-text">2 khách</span>
                </div>
                <div class="guest-box" id="guest-box">
                    <div class="guest-row">
                        <span>Người lớn</span>
                        <div class="guest-counter">
                            <button type="button" onclick="updateGuest('adult', -1)">-</button>
                            <span id="adult-count">2</span>
                            <button type="button" onclick="updateGuest('adult', 1)">+</button>
                        </div>
                    </div>
                    <div class="guest-row">
                        <span>Trẻ em</span>
                        <div class="guest-counter">
                            <button type="button" onclick="updateGuest('child', -1)">-</button>
                            <span id="child-count">0</span>
                            <button type="button" onclick="updateGuest('child', 1)">+</button>
                        </div>
                    </div>
                    <div class="guest-row">
                        <span>Em bé</span>
                        <div class="guest-counter">
                            <button type="button" onclick="updateGuest('baby', -1)">-</button>
                            <span id="baby-count">0</span>
                            <button type="button" onclick="updateGuest('baby', 1)">+</button>
                        </div>
                    </div>
                </div>
                <input type="hidden" name="adult" id="adult-input" value="1">
                <input type="hidden" name="child" id="child-input" value="0">
                <input type="hidden" name="baby" id="baby-input" value="0">
            </div>

            <!-- Nút tìm -->
            <div class="search-button" style="flex: 0 0 auto;">
                <button type="submit">Tìm ngay</button>
            </div>
        </div>

    </form>
    </div>
	 <script>
		document.addEventListener('DOMContentLoaded', function () {
			const form = document.querySelector('.hotel-search-form');
			form.addEventListener('submit', function (e) {
				e.preventDefault();
				const select = form.querySelector('[name="location"]');
				const slug = select.value;

				if (slug) {
					window.location.href = '/vung_mien_hotel/' + slug + '/';
				} 
			});
		});
		</script>
        <script>
        function updateGuest(type, delta) {
            const limits = {
                adult: { min: 1, max: 20 },
                child: { min: 0, max: 8 },
                baby:  { min: 0, max: 4 }
            };

            const countSpan = document.getElementById(type + '-count');
            let count = parseInt(countSpan.innerText);

            count += delta;

            if (count < limits[type].min) count = limits[type].min;
            if (count > limits[type].max) count = limits[type].max;

            countSpan.innerText = count;

            // Gán vào input ẩn
            document.getElementById(type + '-input').value = count;

            // Update hiển thị tổng khách
            const adult = parseInt(document.getElementById('adult-count').innerText);
            const child = parseInt(document.getElementById('child-count').innerText);
            const baby  = parseInt(document.getElementById('baby-count').innerText);

            const total = adult + child + baby;
            document.getElementById('guest-summary-text').innerText = total + ' khách';
        }
        </script>

    <?php
    return ob_get_clean();
}
add_shortcode('hotel_filter_form', 'hotel_filter_form_shortcode');
// chủ đề khách sạn
function hotel_chu_de_hap_dan_shortcode() {
    ob_start();

    $terms = get_terms([
        'taxonomy' => 'chu_de_hotel',
        'hide_empty' => false,
    ]);

    if (!empty($terms) && !is_wp_error($terms)) {
        echo '<div class="chu-de-carousel" style="display: flex; gap: 16px; overflow-x: auto; scroll-snap-type: x mandatory; padding-bottom: 10px;">';

        foreach ($terms as $term) {
            $image = get_field('thumbnail', 'chu_de_hotel_' . $term->term_id);
            $link = get_term_link($term);

            echo '<a href="' . esc_url($link) . '" class="chu-de-item" style="position:relative; flex: 0 0 280px; height:180px; border-radius:12px; overflow:hidden; scroll-snap-align: start; text-decoration:none;">';
            if ($image) {
                echo '<img src="' . esc_url($image) . '" style="width:100%; height:100%; object-fit:cover;" />';
            }
            echo '<div style="position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;color:white;font-size:18px;font-weight:bold;background:rgba(0,0,0,0.3);text-align:center;">' . esc_html($term->name) . '</div>';
            echo '</a>';
        }

        echo '</div>';
    }

    return ob_get_clean();
}
add_shortcode('chu_de_hotel', 'hotel_chu_de_hap_dan_shortcode');
// short code khach san taxonomy
function hotel_vungmien_top6_shortcode() {
    ob_start();

    // Lấy các term vung_mien có nhiều khách sạn nhất
    $terms = get_terms([
        'taxonomy' => 'vung_mien_hotel',
        'hide_empty' => false,
    ]);

    $terms_data = [];

    foreach ($terms as $term) {
        $query = new WP_Query([
            'post_type' => 'hotel',
            'posts_per_page' => -1,
            'tax_query' => [[
                'taxonomy' => 'vung_mien_hotel',
                'field' => 'term_id',
                'terms' => $term->term_id,
                'include_children' => false,
            ]]
        ]);
        $hotel_count = $query->found_posts;
        wp_reset_postdata();

        if ($hotel_count > 0) {
            $terms_data[] = [
                'term' => $term,
                'count' => $hotel_count
            ];
        }
    }

    // Sắp xếp giảm dần theo số lượng
    usort($terms_data, function($a, $b) {
        return $b['count'] - $a['count'];
    });

    // Lấy 6 cái đầu tiên
    $top_terms = array_slice($terms_data, 0, 8);

    if (empty($top_terms)) {
        return 'Không tìm thấy vùng miền nào.';
    }

    ?>
    <div style="max-width:1140px;margin:auto;padding:24px;">
      <div style="display:flex;gap:32px;align-items:flex-start;flex-wrap:wrap;">
        <!-- Bên trái -->
        <div style="flex:0 0 300px;">
          <h2 style="margin-top:0;">Điểm đến trong nước nổi bật</h2>
          <p>Cơ hội đặt phòng khách sạn tại những điểm đến được lựa chọn nhiều nhất. Khám phá ngay!</p>
          <a href="/vung_mien_hotel/du-lich-trong-nuoc/" style="display:inline-block;margin-top:16px;padding:10px 20px;border:1px solid #007bff;border-radius:8px;color:#007bff;text-decoration:none;">Xem khách sạn toàn quốc &raquo;</a>
        </div>

        <!-- Bên phải -->
        <div style="flex:1;display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:16px;">
        
          <?php foreach ($top_terms as $item):
            $term = $item['term'];
            $hotel_count = $item['count'];
            $image_url = get_field('thumbnail', $term);
            
            $link = get_term_link($term);
          ?>
            <a href="<?php echo esc_url($link); ?>" style="position:relative;display:block;height:150px;border-radius:12px;overflow:hidden;background:url('<?php echo esc_url($image_url); ?>') center/cover no-repeat;text-decoration:none;color:white;">
              <div style="background:rgba(0,0,0,0.4);position:absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;justify-content:center;align-items:center;">
                <div style="font-weight:bold;font-size:18px;"><?php echo esc_html($term->name); ?></div>
                <div style="font-size:14px;"><?php echo esc_html($hotel_count); ?> khách sạn</div>
              </div>
            </a>
          <?php endforeach; ?>
        </div>
      </div>
    </div>
    <?php

    return ob_get_clean();
}
add_shortcode('hotel_vungmien_top6', 'hotel_vungmien_top6_shortcode');
// form search combo
function combo_search_form_shortcode() {
    ob_start(); ?>
    
    <style>
    .combo-search-wrapper {
        max-width: 960px;
        margin-top: -120px;
        position: relative;
        z-index: 99;
    }
    .combo-search-form {
        background: #fff;
        padding: 20px 28px;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        display: flex;
        flex-direction: column;
        gap: 16px;
        font-size: 14px;
    }
    .combo-search-form h2 {
        font-size: 22px; /* giảm từ 26-28 xuống */
        font-weight: 600;
        margin-bottom: 4px;
    }
    .combo-search-row {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        align-items: flex-end;
    }
    .combo-search-group {
        flex: 1;
        min-width: 180px;
    }
    .combo-search-group label {
        font-weight: 600;
        font-size: 13px;
        color: #777;
        margin-bottom: 4px;
        display: block;
    }
    .combo-search-group select,
    .combo-search-group input[type="date"] {
        width: 100%;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid #ccc;
        font-size: 14px;
    }
    .combo-search-button {
        flex-shrink: 0;
    }
    .combo-search-button button {
        padding: 12px 28px;
        background-color: #660000;
        color: #fff;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: bold;
        cursor: pointer;
    }
    </style>

    <div class="combo-search-wrapper">
        <form onsubmit="return redirectToCombo(event);" class="combo-search-form">
            <h2>Combo du lịch</h2>

            <!-- Hàng 1: Địa điểm -->
            <div class="combo-search-row">
                <div class="combo-search-group">
                    <label>ĐỊA ĐIỂM</label>
                    <select name="diadiem">
                        <option value="">Bạn muốn đi đâu?</option>
                        <?php
                        $terms = get_terms([
                            'taxonomy' => 'vung_mien_combo',
                            'hide_empty' => false,
                        ]);
                        foreach ($terms as $term) {
                            $parent = get_term($term->parent, 'vung_mien_combo');
                            $grandparent = $parent ? get_term($parent->parent, 'vung_mien_combo') : null;
                            if ($grandparent) {
                                echo '<option value="' . esc_attr($term->slug) . '">' . esc_html($term->name) . '</option>';
                            }
                        }
                        ?>
                    </select>
                </div>
            </div>

            <!-- Hàng 2: Ngày + khởi hành -->
            <div class="combo-search-row">
                <div class="combo-search-group">
                    <label>NGÀY KHỞI HÀNH</label>
                    <input type="date" name="ngay_khoi_hanh">
                </div>

                <div class="combo-search-group">
                    <label>KHỞI HÀNH TỪ</label>
                    <select name="khoihanh">
                        <option value="">Vui lòng chọn</option>
                        <option value="ha-noi">Hà Nội</option>
                        <option value="ho-chi-minh">Hồ Chí Minh</option>
                        <option value="da-nang">Đà Nẵng</option>
                        <option value="hai-phong">Hải Phòng</option>
                    </select>
                </div>

                <div class="combo-search-button">
                    <button type="submit">Tìm ngay</button>
                </div>
            </div>
        </form>
    </div>

    <script>
    function redirectToCombo(e) {
        e.preventDefault();
        const form = e.target;
        const location = form.querySelector('[name="diadiem"]').value;

        if (location) {
            window.location.href = '/vung_mien_combo/' + location + '/';
        }
        return false;
    }
    </script>

    <?php
    return ob_get_clean();
}
add_shortcode('combo_search_form', 'combo_search_form_shortcode');
/// short code combo grid

function render_tour_grid() {
    $args = array(
        'post_type' => 'tour',
        'posts_per_page' => 8,
    );

    $query = new WP_Query($args);
    $output = '<div class="tour-grid" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-between;">';

    while ($query->have_posts()) : $query->the_post();
        $id = get_the_ID();
        $title = get_the_title();
        $permalink = get_permalink();
        $thumbnail = get_field('anh_dai_dien_tour',$id);

        $badge = get_field('noi_bat', $id);
        $rating = get_field('danh_gia', $id);
        $rating_text = get_field('rating_text', $id);
        $rating_count = get_field('so_luot_danh_gia', $id);
        $places = get_field('lo_trinh', $id);
        $duration = get_field('thoi_gian', $id);
        $old_price = get_field('gia_goc', $id);
        $new_price = get_field('gia_tour', $id);
        $promotion = get_field('promotion', $id);
        $promotion_html = '';

        if (is_array($promotion)) {
            foreach ($promotion as $item) {
                $promotion_html .= '<div style="margin-bottom: 4px;">🎁 ' . esc_html($item) . '</div>';
            }
        } elseif (!empty($promotion)) {
            $promotion_html = '<div>🎁 ' . esc_html($promotion) . '</div>';
        }

        $output .= '
        <div class="tour-card" style="flex: 1 1 calc(100% / 4 - 20px); box-sizing: border-box; border: 1px solid #eee; border-radius: 10px; overflow: hidden; background: #fff; max-width: calc(100% / 4 - 20px);">
            <a href="' . $permalink . '" style="text-decoration: none; color: inherit;">
                <div style="position: relative;">
                    <img src="' . $thumbnail . '" alt="' . esc_attr($title) . '" style="width: 100%; height: 180px; object-fit: cover;">
                    ' . ($badge ? '<div style="position: absolute; top: 10px; left: 10px; background: red; color: white; padding: 4px 8px; font-size: 12px; border-radius: 4px;">' . esc_html($badge) . '</div>' : '') . '
                </div>
                <div style="padding: 12px;">
                    <h3 style="font-size: 16px; margin: 0 0 6px;">' . esc_html($title) . '</h3>

                    <div style="margin-bottom: 8px;">
                        <span style="background:#007bff; color:white; padding:2px 6px; border-radius:4px;">' . esc_html($rating) . '</span>
                        <strong>' . esc_html($rating_text) . '</strong> – ' . esc_html($rating_count) . ' đánh giá
                    </div>

                    <div style="font-size: 14px; color: #555; margin-bottom: 8px;">
                        📍 ' . esc_html($places) . '
                    </div>

                    <div style="font-size:14px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 6px;">
                        <span style="padding:4px 6px; background:#eee; border-radius:4px;">' . esc_html($duration) . '</span>
<span>
                        ' . (is_numeric($old_price) && $old_price > 0 ? '<del style="color:gray;">' . number_format($old_price, 0, ',', '.') . 'đ</del><br>' : '') . '
                        ' . (is_numeric($new_price) && $new_price > 0 ? '<strong style="color:red;">' . number_format($new_price, 0, ',', '.') . 'đ</strong>' : '<strong>Liên hệ</strong>') . '
                        </span>
                    </div>

                    ' . ($promotion_html ? '<div style="margin-top:10px; background: #fce9d2; color:#e1703a; padding: 5px 10px; border-radius: 6px; font-size: 13px;">' . $promotion_html . '</div>' : '') . '
                </div>
            </a>
        </div>';
    endwhile;

    $output .= '</div>
    <style>
    @media (max-width: 768px) {
        .tour-grid {
            flex-direction: column;
        }
        .tour-card {
            width: 100% !important;
            max-width: 100% !important;
        }
    }
    </style>';

    wp_reset_postdata();
    return $output;
}
add_shortcode('tour_grid', 'render_tour_grid');
/// short code combo grid

function render_combo_grid() {
    $args = array(
        'post_type' => 'combo',
        'posts_per_page' => 6,
    );

    $query = new WP_Query($args);
    $output = '<div class="tour-grid" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-between;">';

    while ($query->have_posts()) : $query->the_post();
        $id = get_the_ID();
        $title = get_the_title();
        $permalink = get_permalink();
        $thumbnail = get_field('anh_dai_dien_tour',$id);

        $badge = get_field('noi_bat', $id);
        $rating = get_field('danh_gia', $id);
        $rating_text = get_field('rating_text', $id);
        $rating_count = get_field('so_luot_danh_gia', $id);
        $places = get_field('lo_trinh', $id);
        $duration = get_field('thoi_gian', $id);
        $old_price = get_field('gia_goc', $id);
        $new_price = get_field('gia_tour', $id);
        $promotion = get_field('promotion', $id);
        $promotion_html = '';

        if (is_array($promotion)) {
            foreach ($promotion as $item) {
                $promotion_html .= '<div style="margin-bottom: 4px;">🎁 ' . esc_html($item) . '</div>';
            }
        } elseif (!empty($promotion)) {
            $promotion_html = '<div>🎁 ' . esc_html($promotion) . '</div>';
        }

        $output .= '
        <div class="tour-card" style="flex: 1 1 calc(100% / 4 - 20px); box-sizing: border-box; border: 1px solid #eee; border-radius: 10px; overflow: hidden; background: #fff; max-width: calc(100% / 4 - 20px);">
            <a href="' . $permalink . '" style="text-decoration: none; color: inherit;">
                <div style="position: relative;">
                    <img src="' . $thumbnail . '" alt="' . esc_attr($title) . '" style="width: 100%; height: 180px; object-fit: cover;">
                    ' . ($badge ? '<div style="position: absolute; top: 10px; left: 10px; background: red; color: white; padding: 4px 8px; font-size: 12px; border-radius: 4px;">' . esc_html($badge) . '</div>' : '') . '
                </div>
                <div style="padding: 12px;">
                    <h3 style="font-size: 16px; margin: 0 0 6px;">' . esc_html($title) . '</h3>

                    <div style="margin-bottom: 8px;">
                        <span style="background:#007bff; color:white; padding:2px 6px; border-radius:4px;">' . esc_html($rating) . '</span>
                        <strong>' . esc_html($rating_text) . '</strong> – ' . esc_html($rating_count) . ' đánh giá
                    </div>

                    <div style="font-size: 14px; color: #555; margin-bottom: 8px;">
                        📍 ' . esc_html($places) . '
                    </div>

                    <div style="font-size:14px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 6px;">
                        <span style="padding:4px 6px; background:#eee; border-radius:4px;">' . esc_html($duration) . '</span>
<span>
                        ' . (is_numeric($old_price) && $old_price > 0 ? '<del style="color:gray;">' . number_format($old_price, 0, ',', '.') . 'đ</del><br>' : '') . '
                        ' . (is_numeric($new_price) && $new_price > 0 ? '<strong style="color:red;">' . number_format($new_price, 0, ',', '.') . 'đ</strong>' : '<strong>Liên hệ</strong>') . '
                        </span>
                    </div>

                    ' . ($promotion_html ? '<div style="margin-top:10px; background: #fce9d2; color:#e1703a; padding: 5px 10px; border-radius: 6px; font-size: 13px;">' . $promotion_html . '</div>' : '') . '
                </div>
            </a>
        </div>';
    endwhile;

    $output .= '</div>
    <style>
    @media (max-width: 768px) {
        .tour-grid {
            flex-direction: column;
        }
        .tour-card {
            width: 100% !important;
            max-width: 100% !important;
        }
    }
    </style>';

    wp_reset_postdata();
    return $output;
}
add_shortcode('combo_grid', 'render_combo_grid');

// short code combo taxonomy
function combo_vungmien_top6_shortcode() {
    ob_start();

    // Lấy các term vung_mien có nhiều khách sạn nhất
    $terms = get_terms([
        'taxonomy' => 'vung_mien_combo',
        'hide_empty' => false,
    ]);

    $terms_data = [];

    foreach ($terms as $term) {
        $query = new WP_Query([
            'post_type' => 'combo',
            'posts_per_page' => -1,
            'tax_query' => [[
                'taxonomy' => 'vung_mien_combo',
                'field' => 'term_id',
                'terms' => $term->term_id,
                'include_children' => false,
            ]]
        ]);
        $combo_count = $query->found_posts;
        wp_reset_postdata();

        if ($combo_count > 0) {
            $terms_data[] = [
                'term' => $term,
                'count' => $combo_count
            ];
        }
    }

    // Sắp xếp giảm dần theo số lượng
    usort($terms_data, function($a, $b) {
        return $b['count'] - $a['count'];
    });

    // Lấy 6 cái đầu tiên
    $top_terms = array_slice($terms_data, 0, 8);

    if (empty($top_terms)) {
        return 'Không tìm thấy vùng miền nào.';
    }

    ?>
    <div style="max-width:1140px;margin:auto;padding:24px;">
      <div style="display:flex;gap:32px;align-items:flex-start;flex-wrap:wrap;">
        <!-- Bên trái -->
        <div style="flex:0 0 300px;">
          <h2 style="margin-top:0;">Combo du lịch độc đáo</h2>
          <p>Đừng bỏ qua những combo du lịch độc đáo với những khuyến mại hấp dẫn tại các điểm đến xinh đẹp và nổi tiếng. Nhanh tay khám phá ngay thôi!</p>
        </div>

        <!-- Bên phải -->
        <div style="flex:1;display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:16px;">
          <?php foreach ($top_terms as $item):
            $term = $item['term'];
            $combo_count = $item['count'];
            $image_url = get_field('thumbnail',  $term);
            
            $link = get_term_link($term);
          ?>
            <a href="<?php echo esc_url($link); ?>" style="position:relative;display:block;height:150px;border-radius:12px;overflow:hidden;background:url('<?php echo esc_url($image_url); ?>') center/cover no-repeat;text-decoration:none;color:white;">
              <div style="background:rgba(0,0,0,0.4);position:absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;justify-content:center;align-items:center;">
                <div style="font-weight:bold;font-size:18px;"><?php echo esc_html($term->name); ?></div>
                <div style="font-size:14px;"><?php echo esc_html($combo_count); ?> khách sạn</div>
              </div>
            </a>
          <?php endforeach; ?>
        </div>
      </div>
    </div>
    <?php

    return ob_get_clean();
}
add_shortcode('combo_vungmien_top6', 'combo_vungmien_top6_shortcode');

// chủ đề combo
function combo_chu_de_hap_dan_shortcode() {
    ob_start();

    $terms = get_terms([
        'taxonomy' => 'chu_de_combo',
        'hide_empty' => false,
    ]);

    if (!empty($terms) && !is_wp_error($terms)) {
        echo '<div class="chu-de-carousel" style="display: flex; gap: 16px; overflow-x: auto; scroll-snap-type: x mandatory; padding-bottom: 10px;">';

        foreach ($terms as $term) {
            $image = get_field('thumbnail', 'chu_de_combo_' . $term->term_id);
            $link = get_term_link($term);

            echo '<a href="' . esc_url($link) . '" class="chu-de-item" style="position:relative; flex: 0 0 280px; height:180px; border-radius:12px; overflow:hidden; scroll-snap-align: start; text-decoration:none;">';
            if ($image) {
                echo '<img src="' . esc_url($image) . '" style="width:100%; height:100%; object-fit:cover;" />';
            }
            echo '<div style="position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;color:white;font-size:18px;font-weight:bold;background:rgba(0,0,0,0.3);text-align:center;">' . esc_html($term->name) . '</div>';
            echo '</a>';
        }

        echo '</div>';
    }

    return ob_get_clean();
}
add_shortcode('chu_de_combo', 'combo_chu_de_hap_dan_shortcode');
// form thanh toán khách sạn 
function hotel_booking_form_shortcode() {
    ob_start();
    global $post;
    if (!$post || $post->post_type !== 'hotel') {
        return '<p style="color:red;">Không tìm thấy thông tin khách sạn.</p>';
    }
    $post_id = get_the_ID();
    $tieu_de = get_the_title($post_id);
    $dia_chi = get_field('dia_chi_1', $post_id);

    // Lấy thông tin loại phòng đầu tiên
    $ten_phong = 'Phòng tiêu chuẩn';
    $dien_tich = '';
    $so_nguoi = '';
    $so_giuong = '';
    $gia_phong = 1000000;

    if (have_rows('loai_phong', $post_id)) {
        the_row(); // Lấy phòng đầu tiên
        $ten_phong = get_sub_field('ten_phong') ?: $ten_phong;
        $dien_tich = get_sub_field('dien_tich_phong');
        $so_nguoi = get_sub_field('so_nguoi');
        $so_giuong = get_sub_field('so_giuong');
        $gia_phong = isset($_GET['price']) ? intval($_GET['price']) : 0;
    }
    ?>

    <div class="hotel-booking-box">
        <h2>Chi tiết đặt phòng</h2>
        <h3><?php echo esc_html($tieu_de); ?></h3>
        <p>📍 <?php echo esc_html($dia_chi); ?></p>

        <div class="checkin-checkout-row">
            <div class="date-group">
                <label>Ngày nhận phòng:</label>
                <input type="date" id="checkin" required>
            </div>
            <div class="date-group">
                <label>Ngày trả phòng:</label>
                <input type="date" id="checkout" required>
            </div>
        </div>

        <!-- Số phòng -->
        <div class="room-quantity">
            <label for="so-phong">Số phòng:</label>
            <div class="qty-wrapper">
                <button type="button" class="qty-btn" id="minus">−</button>
                <input type="number" id="so-phong" value="1" min="1" step="1">
                <button type="button" class="qty-btn plus" id="plus">+</button>
            </div>
        </div>

        <div class="booking-table">
            <div class="booking-row header">
                <div>Số đêm phòng</div>
                <div>Loại phòng</div>
                <div>Điều kiện phòng</div>
                <div>Giường phụ</div>
                <div>Giá phòng/đêm</div>
            </div>
            <div class="booking-row">
                <div><span id="so-dem">1 phòng x 1 đêm</span></div>
                <div>
                    <?php echo esc_html($ten_phong); ?><br>
                    Diện tích <?php echo esc_html($dien_tich); ?>m², <?php echo esc_html($so_giuong); ?> giường<br>
                    <a href="#">Xem chi tiết</a>
                </div>
                <div>
                    Phòng dành cho <?php echo esc_html($so_nguoi); ?> khách<br>
                    <b>ĐÃ</b> bao gồm ăn sáng<br>
                    <b>ĐÃ</b> bao gồm thuế VAT và phí dịch vụ<br>
                    <span style="color:red">Không hoàn/hủy phòng</span>
                </div>
                <div>
                    <select><option>0</option><option>1</option><option>2</option></select>
                </div>
                <div><b><?php echo number_format($gia_phong, 0, ',', '.'); ?>đ</b></div>
            </div>
        </div>

        <div class="booking-summary">
            <div class="summary-line">
                <span id="room-summary">1 <?php echo esc_html($ten_phong); ?></span>
                <span id="tien-phong"><?php echo number_format($gia_phong, 0, ',', '.'); ?>đ</span>
            </div>
            <div class="summary-line">
                <span>Thuế & phí</span>
                <span id="thue-phi">463.000đ</span>
            </div>
            <div class="discount-box">
                <input type="text" placeholder="Nhập mã giảm giá">
            </div>
            <div class="summary-line total">
                <span>Tổng tiền:</span>
                <span style="color: red; font-weight: bold;" id="tong-tien">...</span>
            </div>
            <p><strong>+ <span id="diem-thuong">...</span> điểm</strong></p>
        </div>

        <hr style="margin: 30px 0;">
        <div class="contact-info">
            <h3>Thông tin Liên hệ</h3>
            <form>
                <div class="gender-options">
                    <label class="gender-label">Quý danh*:</label>
                    <label><input type="radio" name="gender" required> Ông</label>
                    <label><input type="radio" name="gender"> Bà</label>
                    <label><input type="radio" name="gender"> Anh</label>
                    <label><input type="radio" name="gender"> Chị</label>
                </div>

                <input type="text" placeholder="Họ và tên" required style="width: 100%; padding: 8px;"><br><br>
                <input type="text" placeholder="Số điện thoại*" required style="width: 48%; padding: 8px; display: inline-block; margin-right: 4%;">
                <input type="email" placeholder="Email" style="width: 48%; padding: 8px; display: inline-block;"><br><br>
                <textarea placeholder="Nội dung yêu cầu" style="width: 100%; height: 80px; padding: 8px;"></textarea><br><br>
                <label><input type="checkbox"> Tôi muốn xuất hóa đơn đỏ.</label><br><br>

                <p style="font-size: 13px;">* Khi Quý khách nhấn nút "Gửi yêu cầu đặt phòng" cũng đồng nghĩa là Quý khách đã đồng ý với các <a href="#" target="_blank">điều khoản và điều kiện</a>.</p>

                <button type="submit" style="background-color: #ff7800; color: white; padding: 12px 25px; font-size: 16px; border: none; cursor: pointer;">Gửi yêu cầu đặt phòng</button>
            </form>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const checkin = document.getElementById('checkin');
        const checkout = document.getElementById('checkout');
        const soPhongInput = document.getElementById('so-phong');
        const btnMinus = document.getElementById('minus');
        const btnPlus = document.getElementById('plus');
        const giaPhong = <?php echo intval($gia_phong); ?>;
        const thuePhi = 463000;

        const today = new Date();
        const tomorrow = new Date();
        tomorrow.setDate(today.getDate() + 1);

        const todayStr = today.toISOString().split('T')[0];
        const tomorrowStr = tomorrow.toISOString().split('T')[0];

        checkin.value = todayStr;
        checkout.value = tomorrowStr;
        checkout.min = tomorrowStr;

        function updatePrice() {
            const inDate = new Date(checkin.value);
            const outDate = new Date(checkout.value);
            const soPhong = parseInt(soPhongInput.value) || 1;

            if (!checkin.value || !checkout.value || outDate <= inDate) {
                document.getElementById('so-dem').innerText = `${soPhong} phòng x ? đêm`;
                document.getElementById('room-summary').innerText = `${soPhong} phòng`;
                document.getElementById('tien-phong').innerText = '...';
                document.getElementById('tong-tien').innerText = '...';
                document.getElementById('diem-thuong').innerText = '...';
                return;
            }

            const soDem = Math.ceil((outDate - inDate) / (1000 * 60 * 60 * 24));
            const tienPhong = giaPhong * soDem * soPhong;
            const tong = tienPhong + thuePhi;
            const diem = Math.round(tong * 0.01);

            document.getElementById('so-dem').innerText = `${soPhong} phòng x ${soDem} đêm`;
            document.getElementById('room-summary').innerText = `${soPhong} <?php echo esc_js($ten_phong); ?>`;
            document.getElementById('tien-phong').innerText = tienPhong.toLocaleString('vi-VN') + 'đ';
            document.getElementById('tong-tien').innerText = tong.toLocaleString('vi-VN') + 'đ';
            document.getElementById('diem-thuong').innerText = diem.toLocaleString('vi-VN');
        }

        checkin.addEventListener('change', () => {
            const inDate = new Date(checkin.value);
            const minCheckout = new Date(inDate);
            minCheckout.setDate(minCheckout.getDate() + 1);
            checkout.min = minCheckout.toISOString().split('T')[0];
            if (new Date(checkout.value) <= inDate) {
                checkout.value = checkout.min;
            }
            updatePrice();
        });

        checkout.addEventListener('change', updatePrice);
        btnMinus.addEventListener('click', () => {
            let val = Math.max(1, parseInt(soPhongInput.value) - 1);
            soPhongInput.value = val;
            updatePrice();
        });
        btnPlus.addEventListener('click', () => {
            let val = parseInt(soPhongInput.value) + 1;
            soPhongInput.value = val;
            updatePrice();
        });

        updatePrice();
    });
    </script>

    <style>
.hotel-booking-box {
    border: 1px solid #ddd;
    padding: 20px;
    max-width: 960px;
    margin: 0 auto;
    font-family: Arial;
}
.checkin-checkout-row {
    display: flex;
    gap: 30px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}
.date-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}
.date-group input[type="date"] {
    padding: 6px;
    width: 180px;
}

.room-quantity {
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 600;
    font-size: 16px;
    margin: 20px 0;
}
.qty-wrapper {
    display: flex;
    align-items: stretch;
    border: none;
}
.qty-btn {
    width: 36px;
    height: 40px;
    font-size: 16px;
    font-weight: bold;
    border: none;
    cursor: pointer;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}
.qty-btn#minus {
    background-color: #999;
    border-radius: 20px 0 0 20px;
    margin-right: -1px;
}
.qty-btn#plus {
    background-color: #009BFF;
    border-radius: 0 20px 20px 0;
    margin-left: -1px;
}
.qty-wrapper input {
    width: 46px;
    height: 40px;
    text-align: center;
    font-size: 16px;
    font-weight: bold;
    border: 1px solid #eee;
    border-left: none;
    border-right: none;
    padding: 0;
    background: #fff;
    color: #333;
}
.booking-table {
    border: 1px solid #ddd;
    display: table;
    width: 100%;
    margin-bottom: 20px;
}
.booking-row {
    display: table-row;
}
.booking-row > div {
    display: table-cell;
    padding: 10px;
    border: 1px dashed #ccc;
    vertical-align: top;
}
.booking-row.header > div {
    background-color: #f9f9f9;
    font-weight: bold;
    text-align: center;
}
.booking-summary {
    border-top: 1px solid #ccc;
    padding-top: 10px;
}
.summary-line {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
}
.summary-line.total {
    font-size: 18px;
}
.discount-box {
    margin: 10px 0;
}
.discount-box input {
    width: 100%;
    padding: 8px;
}
.gender-options {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}
.gender-label {
    min-width: 90px;
    font-weight: bold;
}
.contact-info form input,
.contact-info form textarea {
    font-size: 14px;
}
.hotel-booking-box button[type="submit"] {
    background-color: #ff7800;
    color: white;
    padding: 12px 25px;
    font-size: 16px;
    border: none;
    cursor: pointer;
    margin-top: 10px;
}
.hotel-booking-box button[type="submit"]:hover {
    background-color: #e06600;
}

/* Xóa mũi tên input số */
#so-phong::-webkit-inner-spin-button,
#so-phong::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
#so-phong {
    -moz-appearance: textfield;
}

/* Mobile responsive */
@media screen and (max-width: 768px) {
    .checkin-checkout-row {
        flex-direction: column;
    }
    .booking-row {
        display: block;
        margin-bottom: 20px;
        border: 1px dashed #ccc;
    }
    .booking-row > div {
        display: block;
        border: none;
        border-bottom: 1px dashed #ccc;
        padding: 10px;
    }
    .booking-row > div:last-child {
        border-bottom: none;
    }
    .booking-row.header {
        display: none;
    }
    .summary-line {
        flex-direction: column;
        gap: 4px;
    }
}
</style>

    <?php
    return ob_get_clean();
}
add_shortcode('hotel_booking_form', 'hotel_booking_form_shortcode');
//form thanh toán
function form_thanh_toan_shortcode() {
    ob_start();
    $gia_tour = isset($_GET['price']) ? intval($_GET['price']) : 0;
    ?>
    <style>
    .form-tour-wrapper {
        max-width: 800px;
        margin: auto;
        font-family: Arial, sans-serif;
    }
    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }
    .form-grid label {
        font-weight: 500;
        font-size: 14px;
        display: flex;
        flex-direction: column;
    }
    .form-grid input,
    .form-grid select,
    .form-grid textarea {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-top: 5px;
        font-size: 14px;
    }
    .form-grid textarea {
        resize: vertical;
    }
    .form-grid .full-row {
        grid-column: 1 / -1;
    }
    .form-submit {
        text-align: center;
        margin-top: 20px;
    }
    .form-submit button {
        padding: 12px 40px;
        background: #660000;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
    }
    .highlight-option {
        background: #fff8e1;
        padding: 10px;
        border: 2px solid #ffa000;
        border-radius: 6px;
    }
    .price-display {
        font-weight: bold;
        font-size: 18px;
        margin-top: 10px;
        color: #333;
    }
    /* Chỉnh 2 dòng giá gần nhau hơn và đẹp hơn */
    .price-display {
        font-weight: bold;
        font-size: 16px;
        color: #333;
    
        display: flex;
        align-items: baseline;
    }

    .price-bf {
        font-size: 16px;
        color: #aaa!important;
        text-decoration: line-through;
        font-style: italic;
        font-weight: normal;
        opacity: 0.7!important;
        margin-bottom: -8px;
    }
    .rules-note {
    background: #f9f9f9;
    padding: 15px;
    border-left: 4px solid #660000;
    margin-bottom: 20px;
    font-size: 14px;
    line-height: 1.5;
}
h2{
    font-size : 20px!important;
}
    </style>

    <div class="form-tour-wrapper">
        <form id="payment-form">
            <div class="rules-note">
                    <strong>Quy định huỷ/đổi dịch vụ:</strong><br>
                    • Huỷ/đổi trước ngày khởi hành <strong>tối thiểu 14 ngày</strong>: Hoàn 100% giá trị thanh toán.<br>
                    • Huỷ/đổi trước ngày khởi hành <strong>dưới 14 ngày</strong>: Khấu trừ 70% nếu đổi sang tour khác hoặc 50% nếu huỷ hoàn toàn.<br>
                    • Thời gian hoàn tiền tối đa <strong>3 ngày làm việc</strong> kể từ thời điểm tiếp nhận yêu cầu.
            </div>
            <div class="form-grid">
                <p class="full-row price-bf">
                    Giá niêm yết: <span id="listed-price"><?= number_format($gia_tour, 0, ',', '.') ?> đ</span>
                </p>
                <p class="full-row price-display">
                    Giá cần thanh toán: <span id="final-price"><?= number_format($gia_tour, 0, ',', '.') ?> đ</span>
                </p>

                <label>Ngày khởi hành:
                    <input type="date" name="ngay_khoi_hanh" onchange="updatePrice()">
                </label>

                <label>Điểm khởi hành:
                    <select name="diem_khoi_hanh" onchange="updatePrice()">
                        <option value="Hà Nội">Hà Nội</option>
                        <option value="TP HCM">TP HCM</option>
                        <option value="Đà Nẵng">Đà Nẵng</option>
                    </select>
                </label>
                <div class="full-row" style="display:grid; grid-template-columns:repeat(3,1fr);gap:15px;">
                    <label>Người lớn:
                        <select name="nguoi_lon" id="nguoi_lon" onchange="updatePrice()">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                        </select>
                    </label>

                    <label>Trẻ em (2-12):
                        <select name="tre_em" id="tre_em" onchange="updatePrice()">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                        </select>
                    </label>

                    <label>Em bé (<2):
                        <select name="em_be" id="em_be" onchange="updatePrice()">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                        </select>
                    </label>
                </div>
                <label>Quý danh:
                    <select name="quy_danh">
                        <option value="Ông">Ông</option>
                        <option value="Bà">Bà</option>
                    </select>
                </label>

                <label>Họ tên: (*)
                    <input type="text" id="user-name" placeholder="Họ tên của bạn" required>
                </label>

                <label>Email: (*)
                    <input type="email" id="user-email" placeholder="Email" required>
                </label>

                <label>Số điện thoại:
                    <input type="tel" id="sdt" placeholder="SĐT">
                </label>

                <label class="full-row highlight-option">
                    Hình thức thanh toán: (*)
                    <select id="payment_type" required onchange="updatePrice()" style="margin-top: 5px; padding: 10px;">
                        <option value="">-- Vui lòng chọn hình thức thanh toán --</option>
                        <option value="100">Thanh toán toàn bộ (giảm thêm 20%)</option>
                        <option value="30">Cọc giữ chỗ</option>
                    </select>
                </label>

                <label class="full-row">Yêu cầu đặc biệt:
                    <textarea name="yeu_cau_dac_biet" rows="3"></textarea>
                </label>

                <div id="qr-popup" class="full-row" style="text-align:center;"></div>
            </div>

            <div class="form-submit">
                <button id="confirm-button" type="button" onclick="submitPayment()">Xác nhận thanh toán</button>
            </div>
        </form>
    </div>

    <script>
        let basePrice = <?= $gia_tour ?>;
        let calculatedAmount = basePrice;

        function updatePrice() {
            const nguoiLon = parseInt(document.getElementById('nguoi_lon').value || 0);
            const treEm = parseInt(document.getElementById('tre_em').value || 0);
            const paymentType = parseInt(document.getElementById('payment_type').value || 0);

            const listedPrice = (nguoiLon * basePrice) + (treEm * basePrice * 0.5);
            let finalPrice = listedPrice;

            if (paymentType === 100) {
                finalPrice *= 0.8; // Giảm 20%
            } else if (paymentType === 30) {
                finalPrice *= 0.3; // Cọc 30%
            }

            calculatedAmount = Math.round(finalPrice);
            document.getElementById('final-price').innerText = calculatedAmount.toLocaleString('vi-VN') + ' đ';
            document.getElementById('listed-price').innerText = Math.round(listedPrice).toLocaleString('vi-VN') + ' đ';
        }

        function submitPayment() {
            document.getElementById("confirm-button").disabled = true;
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const qrPopup = document.getElementById("qr-popup");

            if (!name || !email || calculatedAmount === 0) {
                alert('Vui lòng nhập đủ Họ tên, Email và chọn hình thức thanh toán.');
                return;
            }

            qrPopup.innerHTML = `
                <div style="text-align:center">
                    <p style="font-weight:bold; color:#cc0000;">Đang lấy mã QR tự động... Vui lòng chờ khoảng 2 phút</p>
                    <div id="countdown" style="font-size:24px; font-weight:bold; margin:10px;">02:00</div>
                </div>
            `;
            let timer = 120;
            const interval = setInterval(() => {
                const minutes = String(Math.floor(timer / 60)).padStart(2, '0');
                const seconds = String(timer % 60).padStart(2, '0');
                document.getElementById('countdown').innerText = `${minutes}:${seconds}`;
                if (--timer < 0) clearInterval(interval);
            }, 1000);

            const formData = new URLSearchParams();
            formData.append('price', calculatedAmount);

            fetch("https://resolved-url-tapes-physically.trycloudflare.com/run-bot", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: formData.toString()
            })
            .then(res => res.blob())
            .then(blob => {
                const url = URL.createObjectURL(blob);
                qrPopup.innerHTML = `
                    <div>
                        <p><strong>Mã QR thanh toán:</strong></p>
                        <img src="${url}" style="max-width:300px;"><br><br>
                        <label>Gửi ảnh xác nhận chuyển khoản:
                            <input type="file" id="upload-proof" accept="image/*">
                        </label><br>
                        <button onclick="confirmPayment()">Đã chuyển khoản</button>
                        <p id="confirm-message" style="margin-top:10px; font-weight:bold;"></p>
                    </div>
                `;
            });
        }

        function confirmPayment() {
            const fileInput = document.getElementById('upload-proof');
            const msg = document.getElementById('confirm-message');
            if (!fileInput.files.length) {
                msg.innerText = 'Vui lòng gửi ảnh xác nhận chuyển khoản trước khi xác nhận.';
                msg.style.color = 'red';
                return;
            }
            msg.style.color = 'green';
            msg.innerText = 'Quý khách vui lòng kiểm tra email để xác nhận đặt thành công dịch vụ.';
        }

        window.addEventListener("DOMContentLoaded", updatePrice);
    </script>
    <?php
    return ob_get_clean();
}
add_shortcode('form_thanh_toan', 'form_thanh_toan_shortcode');

//thanh toán khách sạn

function form_thanh_toan_khachsan_shortcode() {
ob_start();
$gia_phong = isset($_GET['price']) ? intval($_GET['price']) : 0;
?>
<style>
/* Giữ nguyên CSS từ form tour */
.form-tour-wrapper {
max-width: 800px;
margin: auto;
font-family: Arial, sans-serif;
}
.form-grid {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 15px;
}
.form-grid label {
font-weight: 500;
font-size: 14px;
display: flex;
flex-direction: column;
}
.form-grid input,
.form-grid select,
.form-grid textarea {
padding: 10px;
border: 1px solid #ccc;
border-radius: 6px;
margin-top: 5px;
font-size: 14px;
}
.form-grid textarea {
resize: vertical;
}
.form-grid .full-row {
grid-column: 1 / -1;
}
.form-submit {
text-align: center;
margin-top: 20px;
}
.form-submit button {
padding: 12px 40px;
background: #660000;
color: white;
border: none;
border-radius: 6px;
font-size: 16px;
cursor: pointer;
}
.highlight-option {
background: #fff8e1;
padding: 10px;
border: 2px solid #ffa000;
border-radius: 6px;
}
.price-display {
font-weight: bold;
font-size: 16px;
color: #333;
display: flex;
align-items: baseline;
}
.price-bf {
font-size: 16px;
color: #aaa!important;
text-decoration: line-through;
font-style: italic;
font-weight: normal;
opacity: 0.7!important;
margin-bottom: -8px;
}
.rules-note {
background: #f9f9f9;
padding: 15px;
border-left: 4px solid #660000;
margin-bottom: 20px;
font-size: 14px;
line-height: 1.5;
}
</style>

<div class="form-tour-wrapper">
<form id="payment-form">
<div class="rules-note">
<strong>Chính sách huỷ phòng:</strong><br>
• Huỷ trước ngày nhận phòng <strong>tối thiểu 7 ngày</strong>: Hoàn 100%.<br>
• Huỷ sau đó: Hoàn tối đa 50% hoặc mất toàn bộ tuỳ theo điều kiện khách sạn.<br>
• Hoàn tiền trong <strong>3 ngày làm việc</strong> từ lúc tiếp nhận.
</div>
<div class="form-grid">
<p class="full-row price-bf">
Giá niêm yết: <span id="listed-price"><?= number_format($gia_phong, 0, ',', '.') ?> đ</span>
</p>
<p class="full-row price-display">
Tổng giá thanh toán: <span id="final-price"><?= number_format($gia_phong, 0, ',', '.') ?> đ</span>
</p>

<label>Ngày nhận phòng:
<input type="date" id="checkin" onchange="updateHotelPrice()">
</label>

<label>Ngày trả phòng:
<input type="date" id="checkout" onchange="updateHotelPrice()">
</label>

<div class="full-row" style="display:grid; grid-template-columns:repeat(3,1fr);gap:15px;">
<label>Người lớn:
<select name="nguoi_lon" id="nguoi_lon" onchange="updateHotelPrice()">
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
<option value="6">6</option>
<option value="7">7</option>
<option value="8">8</option>
<option value="9">9</option>
<option value="10">10</option>
<option value="11">11</option>
<option value="12">12</option>
</select>
</label>
<label>Trẻ em (2-12):
<select name="tre_em" id="tre_em" onchange="updateHotelPrice()">
<option value="0">0</option><option value="1">1</option><option value="2">2</option>
</select>
</label>
<label>Em bé (&lt;2):
<select name="em_be" id="em_be" onchange="updateHotelPrice()">
<option value="0">0</option><option value="1">1</option><option value="2">2</option>
</select>
</label>
</div>

<label>Quý danh:
<select name="quy_danh">
<option value="Ông">Ông</option>
<option value="Bà">Bà</option>
</select>
</label>

<label>Họ tên: (*)
<input type="text" id="user-name" placeholder="Họ tên của bạn" required>
</label>

<label>Email: (*)
<input type="email" id="user-email" placeholder="Email" required>
</label>

<label>Số điện thoại:
<input type="tel" id="sdt" placeholder="SĐT">
</label>

<label class="full-row highlight-option">
Hình thức thanh toán: (*)
<select id="payment_type" required onchange="updateHotelPrice()" style="margin-top: 5px; padding: 10px;">
<option value="">-- Vui lòng chọn hình thức thanh toán --</option>
<option value="100">Thanh toán toàn bộ (giảm thêm 20%)</option>
<option value="30">Cọc giữ chỗ</option>
</select>
</label>

<label class="full-row">Yêu cầu đặc biệt:
<textarea name="yeu_cau_dac_biet" rows="3"></textarea>
</label>

<div id="qr-popup" class="full-row" style="text-align:center;"></div>
</div>

<div class="form-submit">
<button id="confirm-button" type="button" onclick="submitPayment()">Xác nhận thanh toán</button>
</div>
</form>
</div>

<script>
let basePrice = <?= $gia_phong ?>;
let calculatedAmount = basePrice;

function updateHotelPrice() {
    const nguoiLon = parseInt(document.getElementById('nguoi_lon').value || 0);
    const treEm = parseInt(document.getElementById('tre_em').value || 0);
    const paymentType = parseInt(document.getElementById('payment_type').value || 0);
    const checkinEl = document.getElementById('checkin');
    const checkoutEl = document.getElementById('checkout');

    const checkin = new Date(checkinEl.value);
    const checkout = new Date(checkoutEl.value);

    if (checkin && checkout && checkout <= checkin) {
        alert("Ngày trả phòng phải sau ngày nhận phòng.");
        checkoutEl.value = ""; // Reset ngày trả
        document.getElementById('final-price').innerText = '0 đ';
        document.getElementById('listed-price').innerText = '0 đ';
        return;
    }

    let days = Math.ceil((checkout - checkin) / (1000 * 60 * 60 * 24));
    if (isNaN(days) || days <= 0) days = 1;

    const listedPrice = days * ((nguoiLon * basePrice) + (treEm * basePrice * 0.5));
    let finalPrice = listedPrice;

    if (paymentType === 100) {
        finalPrice *= 0.8;
    } else if (paymentType === 30) {
        finalPrice *= 0.3;
    }

    calculatedAmount = Math.round(finalPrice);
    document.getElementById('final-price').innerText = calculatedAmount.toLocaleString('vi-VN') + ' đ';
    document.getElementById('listed-price').innerText = Math.round(listedPrice).toLocaleString('vi-VN') + ' đ';
}

function submitPayment() {
document.getElementById("confirm-button").disabled = true;
const name = document.getElementById('user-name').value.trim();
const email = document.getElementById('user-email').value.trim();
const qrPopup = document.getElementById("qr-popup");

if (!name || !email || calculatedAmount === 0) {
alert('Vui lòng nhập đủ Họ tên, Email và chọn hình thức thanh toán.');
return;
}

qrPopup.innerHTML = `
<div style="text-align:center">
<p style="font-weight:bold; color:#cc0000;">Đang lấy mã QR tự động... Vui lòng chờ khoảng 2 phút</p>
<div id="countdown" style="font-size:24px; font-weight:bold; margin:10px;">02:00</div>
</div>
`;
let timer = 120;
const interval = setInterval(() => {
const minutes = String(Math.floor(timer / 60)).padStart(2, '0');
const seconds = String(timer % 60).padStart(2, '0');
document.getElementById('countdown').innerText = `${minutes}:${seconds}`;
if (--timer < 0) clearInterval(interval);
}, 1000);

const formData = new URLSearchParams();
formData.append('price', calculatedAmount);

fetch("https://resolved-url-tapes-physically.trycloudflare.com/run-bot", {
method: "POST",
headers: { "Content-Type": "application/x-www-form-urlencoded" },
body: formData.toString()
})
.then(res => res.blob())
.then(blob => {
const url = URL.createObjectURL(blob);
qrPopup.innerHTML = `
<div>
<p><strong>Mã QR thanh toán:</strong></p>
<img src="${url}" style="max-width:300px;"><br><br>
<label>Gửi ảnh xác nhận chuyển khoản:
<input type="file" id="upload-proof" accept="image/*">
</label><br>
<button onclick="confirmPayment()">Đã chuyển khoản</button>
<p id="confirm-message" style="margin-top:10px; font-weight:bold;"></p>
</div>
`;
});
}

function confirmPayment() {
const fileInput = document.getElementById('upload-proof');
const msg = document.getElementById('confirm-message');
if (!fileInput.files.length) {
msg.innerText = 'Vui lòng gửi ảnh xác nhận chuyển khoản trước khi xác nhận.';
msg.style.color = 'red';
return;
}
msg.style.color = 'green';
msg.innerText = 'Quý khách vui lòng kiểm tra email để xác nhận đặt thành công dịch vụ.';
}

window.addEventListener("DOMContentLoaded", updateHotelPrice);
</script>
<?php
return ob_get_clean();
}
add_shortcode('form_thanh_toan_khachsan', 'form_thanh_toan_khachsan_shortcode');

/// breadcrum
function custom_breadcrumb() {
    echo '<nav class="breadcrumb" style="font-size: 14px; margin-bottom: 16px;">';
    echo '<a href="' . home_url() . '">Trang chủ</a> &raquo; ';

    if (is_singular()) {
        $post_type = get_post_type();
        $post_type_obj = get_post_type_object($post_type);
        $post_type_label = $post_type_obj->labels->name;

        // Nếu là taxonomy liên quan
        $terms = get_the_terms(get_the_ID(), 'vung_mien_' . $post_type);
        $term_link = '';
        if (!empty($terms) && !is_wp_error($terms)) {
            $first_term = $terms[0];
            $term_link = get_term_link($first_term);
            echo '<a href="' . esc_url($term_link) . '">' . esc_html($first_term->name) . '</a> &raquo; ';
        }

        echo '<span>' . get_the_title() . '</span>';
    }

    elseif (is_tax()) {
        $term = get_queried_object();
        $taxonomy = get_taxonomy($term->taxonomy);
        echo '<a href="' . get_post_type_archive_link('tour') . '">' . esc_html($taxonomy->labels->name) . '</a> &raquo; ';
        echo '<span>' . esc_html($term->name) . '</span>';
    }

    echo '</nav>';
}




/**
 * BC:
 * In v2.7.0 the theme removed the `hello_elementor_body_open()` from `header.php` replacing it with `wp_body_open()`.
 * The following code prevents fatal errors in child themes that still use this function.
 */
if ( ! function_exists( 'hello_elementor_body_open' ) ) {
	function hello_elementor_body_open() {
		wp_body_open();
	}
}

require HELLO_THEME_PATH . '/theme.php';

HelloTheme\Theme::instance();
